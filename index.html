<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TORNADO V8.0 | TITAN EDITION</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --accent: #00f2ff;
            --pink: #ff007b;
            --gold: #ffcc00;
            --green: #00ff88;
            --bg: #05080a;
            --card: rgba(13, 19, 23, 0.95);
            --border: rgba(0, 242, 255, 0.2);
        }

        * { box-sizing: border-box; transition: all 0.2s ease-out; }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: #fff;
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            background-image: 
                radial-gradient(circle at 10% 10%, rgba(0, 242, 255, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 90% 90%, rgba(255, 0, 123, 0.05) 0%, transparent 50%);
        }

        /* Layout */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 20px;
            width: 98vw;
            height: 96vh;
            max-width: 1700px;
        }

        .panel {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 32px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            backdrop-filter: blur(20px);
            box-shadow: 0 20px 60px rgba(0,0,0,0.8);
        }

        /* Navigation */
        .navbar {
            display: flex;
            background: rgba(0,0,0,0.4);
            padding: 12px;
            gap: 8px;
            border-bottom: 1px solid var(--border);
            overflow-x: auto;
        }
        .nav-link {
            padding: 12px 20px;
            border-radius: 16px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 800;
            text-transform: uppercase;
            color: #5d727b;
            white-space: nowrap;
            letter-spacing: 1px;
        }
        .nav-link.active {
            background: rgba(0, 242, 255, 0.1);
            color: var(--accent);
            box-shadow: 0 0 20px rgba(0, 242, 255, 0.15);
        }

        .content { flex: 1; overflow-y: auto; padding: 25px; display: none; flex-direction: column; gap: 20px; }
        .content.active { display: flex; animation: viewIn 0.4s forwards; }
        @keyframes viewIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        /* Crash Radar */
        .crash-area {
            height: 350px;
            background: #080c10;
            border-radius: 24px;
            position: relative;
            overflow: hidden;
            border: 1px solid var(--border);
        }
        #crashCanvas { width: 100%; height: 100%; }
        .crash-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; pointer-events: none; z-index: 5;
        }
        #crashVal { font-family: 'Orbitron'; font-size: 5.5rem; font-weight: 900; text-shadow: 0 0 40px var(--accent); margin: 0; }
        #crashProfit { color: var(--green); font-size: 1.5rem; font-weight: 800; font-family: 'Orbitron'; height: 35px; }

        /* Games UI */
        .game-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .btn {
            border: none; padding: 18px; border-radius: 20px; font-weight: 900;
            cursor: pointer; text-transform: uppercase; font-family: 'Orbitron';
            font-size: 13px; letter-spacing: 1px;
        }
        .btn-main { background: linear-gradient(135deg, var(--accent), #0072ff); color: #000; }
        .btn-green { background: linear-gradient(135deg, var(--green), #00b35d); color: #000; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: #fff; }
        
        input {
            background: rgba(0,0,0,0.5); border: 1px solid var(--border);
            padding: 18px; border-radius: 20px; color: #fff; font-family: 'Orbitron';
            font-size: 16px; width: 100%;
        }

        /* Mines & Ladder Grid */
        .grid-5x5 { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; max-width: 450px; margin: 0 auto; }
        .cell {
            aspect-ratio: 1; background: rgba(255,255,255,0.03); border: 1px solid var(--border);
            border-radius: 14px; cursor: pointer; display: flex; align-items: center;
            justify-content: center; font-size: 24px;
        }
        .cell:hover { background: rgba(0, 242, 255, 0.08); transform: scale(1.05); }
        .cell.active { background: var(--accent); box-shadow: 0 0 20px var(--accent); color: #000; }
        .cell.death { background: var(--pink); box-shadow: 0 0 20px var(--pink); }

        /* Sidebar Stats */
        .user-info { padding: 30px; text-align: center; border-bottom: 1px solid var(--border); }
        .balance-text { font-family: 'Orbitron'; font-size: 2.8rem; font-weight: 900; color: var(--accent); }
        .xp-wrap { margin-top: 15px; }
        .xp-bar { height: 10px; background: rgba(255,255,255,0.05); border-radius: 20px; overflow: hidden; margin-bottom: 5px; }
        .xp-fill { height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent), var(--pink)); box-shadow: 0 0 10px var(--accent); }

        /* Chat */
        .chat-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        #chatBox { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .chat-msg { background: rgba(255,255,255,0.03); padding: 12px 16px; border-radius: 18px; font-size: 13px; border: 1px solid rgba(255,255,255,0.05); }
        .chat-msg b { color: var(--accent); font-family: 'Orbitron'; font-size: 11px; }

        /* Case Anim */
        .cases-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .case-card { background: rgba(255,255,255,0.02); padding: 25px; border-radius: 24px; text-align: center; border: 1px solid var(--border); }
        .case-card h3 { font-family: 'Orbitron'; margin: 0 0 15px 0; }

        #lvlPopup {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9);
            z-index: 10000; display: none; flex-direction: column; align-items: center; justify-content: center;
            animation: fadeIn 0.5s;
        }
        .lvl-num { font-family: 'Orbitron'; font-size: 10rem; color: var(--accent); text-shadow: 0 0 60px var(--accent); }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }
    </style>
</head>
<body>

<div id="lvlPopup"><div class="lvl-num" id="newLvlTxt">2</div><p>–ù–û–í–´–ô –£–†–û–í–ï–ù–¨ –î–û–°–¢–ò–ì–ù–£–¢</p></div>

<div id="authBox" class="panel" style="width: 450px; padding: 50px; position: absolute; z-index: 9999; text-align: center;">
    <h1 style="font-family:'Orbitron'; font-size: 2.5rem; margin:0; background:linear-gradient(to right, #00f2ff, #ff007b); -webkit-background-clip:text; -webkit-text-fill-color:transparent;">TORNADO</h1>
    <p style="letter-spacing: 8px; font-size: 10px; color: #5d727b; margin-bottom: 40px;">TITAN V8.0</p>
    
    <input type="text" id="loginU" placeholder="–õ–û–ì–ò–ù" style="margin-bottom: 15px;">
    <input type="password" id="loginP" placeholder="–ü–ê–†–û–õ–¨" style="margin-bottom: 30px;">
    <button class="btn btn-main" style="width: 100%;" onclick="auth()">–í–û–ô–¢–ò –í –°–ò–°–¢–ï–ú–£</button>
    <p style="font-size: 12px; margin-top: 20px; color: #5d727b; cursor: pointer;" onclick="toggleAuthMode()">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –°–æ–∑–¥–∞—Ç—å</p>
</div>

<div class="main-grid" id="gameApp" style="display: none;">
    <div class="panel">
        <div class="navbar">
            <div class="nav-link active" onclick="showTab(this, 'tabCrash')">CRASH</div>
            <div class="nav-link" onclick="showTab(this, 'tabMines')">MINES</div>
            <div class="nav-link" onclick="showTab(this, 'tabLadder')">LADDER</div>
            <div class="nav-link" onclick="showTab(this, 'tabMining')">MINING</div>
            <div class="nav-link" onclick="showTab(this, 'tabCases')">CASES</div>
            <div class="nav-link" onclick="showTab(this, 'tabTop')">LEADERS</div>
            <div class="nav-link" onclick="showTab(this, 'tabPromo')">PROMO</div>
        </div>

        <div id="tabCrash" class="content active">
            <div class="crash-area">
                <canvas id="crashCanvas"></canvas>
                <div class="crash-overlay">
                    <p id="crashVal">1.00x</p>
                    <div id="crashProfit"></div>
                </div>
            </div>
            <div class="game-controls">
                <input type="number" id="crashBet" placeholder="–°–£–ú–ú–ê">
                <input type="number" id="crashAuto" placeholder="–ê–í–¢–û-–í–´–í–û–î">
            </div>
            <button id="crashBtn" class="btn btn-main" style="font-size: 20px;" onclick="handleCrash()">–°–î–ï–õ–ê–¢–¨ –°–¢–ê–í–ö–£</button>
        </div>

        <div id="tabMines" class="content">
            <div class="game-controls">
                <input type="number" id="minesBet" placeholder="–°–¢–ê–í–ö–ê">
                <select id="minesCount" style="background:#000; color:#fff; border:1px solid var(--border); border-radius:20px; padding:0 20px;">
                    <option value="3">3 –ú–ò–ù–´</option>
                    <option value="5">5 –ú–ò–ù</option>
                    <option value="10">10 –ú–ò–ù</option>
                    <option value="24">24 –ú–ò–ù–´</option>
                </select>
            </div>
            <div id="minesGrid" class="grid-5x5"></div>
            <button id="minesAction" class="btn btn-main" onclick="startMines()">–ò–ì–†–ê–¢–¨</button>
        </div>

        <div id="tabLadder" class="content">
            <div class="game-controls" style="margin-bottom: 20px;">
                <input type="number" id="ladderBet" placeholder="–°–¢–ê–í–ö–ê">
                <button id="ladderStartBtn" class="btn btn-main" onclick="startLadder()">–°–¢–ê–†–¢</button>
            </div>
            <div id="ladderGame" style="display:flex; flex-direction:column-reverse; gap:10px; align-items:center;">
                </div>
        </div>

        <div id="tabMining" class="content">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                <button class="btn btn-main" style="height: 150px;" onclick="manualClick()">
                    <span style="font-size:24px;">CLICK MINE</span><br>
                    <span id="clickVal" style="font-size:12px; opacity:0.7;">+2.00 ‚ÇΩ</span>
                </button>
                <div class="case-card" style="display:flex; flex-direction:column; justify-content:center;">
                    <p style="font-size:12px; color:#5d727b;">–ü–ê–°–°–ò–í–ù–´–ô –î–û–•–û–î</p>
                    <h2 id="passiveVal" style="font-family:'Orbitron'; color:var(--green); margin:0;">0 ‚ÇΩ/—Å–µ–∫</h2>
                </div>
            </div>
            <h3 style="font-family:'Orbitron'; margin-top:30px;">–ú–ê–ì–ê–ó–ò–ù –û–ë–û–†–£–î–û–í–ê–ù–ò–Ø</h3>
            <div id="gpuContainer" style="display:grid; gap:15px;"></div>
        </div>

        <div id="tabCases" class="content">
            <div class="cases-grid">
                <div class="case-card">
                    <h3>–ë–û–ú–ñ</h3>
                    <p>–¶–µ–Ω–∞: 500 ‚ÇΩ</p>
                    <button class="btn btn-outline" style="width:100%" onclick="openCase('common', 500)">–û–¢–ö–†–´–¢–¨</button>
                </div>
                <div class="case-card">
                    <h3>–ë–ò–ó–ù–ï–°</h3>
                    <p>–¶–µ–Ω–∞: 5,000 ‚ÇΩ</p>
                    <button class="btn btn-outline" style="width:100%" onclick="openCase('rare', 5000)">–û–¢–ö–†–´–¢–¨</button>
                </div>
                <div class="case-card" style="border-color: var(--gold);">
                    <h3 style="color:var(--gold);">–í–õ–ê–°–¢–ï–õ–ò–ù</h3>
                    <p>–¶–µ–Ω–∞: 50,000 ‚ÇΩ</p>
                    <button class="btn btn-main" style="width:100%" onclick="openCase('epic', 50000)">–û–¢–ö–†–´–¢–¨</button>
                </div>
            </div>
            <div id="caseResult" style="text-align:center; font-size:40px; font-family:'Orbitron'; margin-top:30px;"></div>
        </div>

        <div id="tabTop" class="content">
            <h2 style="font-family:'Orbitron'; text-align:center;">–¢–û–ü 10 –ú–ê–ì–ù–ê–¢–û–í</h2>
            <div id="topList" style="display:flex; flex-direction:column; gap:10px;"></div>
        </div>

        <div id="tabPromo" class="content">
            <input type="text" id="promoIn" placeholder="–ü–†–û–ú–û–ö–û–î">
            <button class="btn btn-main" style="margin-top:20px;" onclick="usePromo()">–ê–ö–¢–ò–í–ò–†–û–í–ê–¢–¨</button>
        </div>
    </div>

    <div class="panel">
        <div class="user-info">
            <div class="balance-text" id="balance">0</div>
            <div class="xp-wrap">
                <div style="display:flex; justify-content:space-between; font-size:10px; font-weight:900; color:#5d727b; margin-bottom:8px;">
                    <span id="lvlTxt">LEVEL 1</span>
                    <span id="xpTxt">0 / 1000 XP</span>
                </div>
                <div class="xp-bar"><div class="xp-fill" id="xpFill"></div></div>
            </div>
        </div>

        <div class="chat-container">
            <div id="chatBox"></div>
            <div style="padding: 20px; display:flex; gap:10px; background: rgba(0,0,0,0.3);">
                <input type="text" id="chatIn" placeholder="–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." style="padding:12px; font-size:14px; border-radius:15px;">
                <button class="btn btn-main" style="padding:0 20px; border-radius:15px;" onclick="sendChat()">></button>
            </div>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
    // --- DATABASE CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyC8UkaoaI7nHRSxNPddRwXnNxzHX7kt8s8",
        authDomain: "tornadogame-41ae2.firebaseapp.com",
        databaseURL: "https://tornadogame-41ae2-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "tornadogame-41ae2",
        appId: "1:926174944730:web:20be5b57efb23ab853b4e3"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- GLOBALS ---
    let user = null, userData = {}, authMode = 'login', audioCtx;
    let crash = { active: false, mult: 1.0, bet: 0, cashed: false, dots: [] };
    let mines = { active: false, bet: 0, bombs: [], opened: 0, total: 3 };
    let ladder = { active: false, bet: 0, level: 0, stones: 2 }; // 2 stones per row means 50/50

    const GPU_DATA = [
        { id: 'gpu1', name: 'NVIDIA GTX 1650', price: 15000, income: 12 },
        { id: 'gpu2', name: 'NVIDIA RTX 3060', price: 80000, income: 75 },
        { id: 'gpu3', name: 'NVIDIA RTX 4090', price: 500000, income: 480 },
        { id: 'gpu4', name: 'ANTMINER S19 PRO', price: 2500000, income: 2800 }
    ];

    // --- SOUND ENGINE ---
    function playSound(freq, type = 'sine', duration = 0.1, vol = 0.07) {
        try {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(vol, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + duration);
        } catch(e) {}
    }

    // --- AUTH ---
    function toggleAuthMode() {
        authMode = authMode === 'login' ? 'reg' : 'login';
        document.querySelector('#authBox h1').innerText = authMode === 'login' ? 'TORNADO' : 'JOIN US';
    }

    function auth() {
        const u = document.getElementById('loginU').value.trim().toLowerCase();
        const p = document.getElementById('loginP').value.trim();
        if(u.length < 3) return alert("–õ–æ–≥–∏–Ω —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π!");

        db.ref('users/' + u).once('value', s => {
            if(authMode === 'login') {
                if(s.exists() && s.val().pass === p) startApp(u, s.val());
                else alert("–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ!");
            } else {
                if(s.exists()) alert("–õ–æ–≥–∏–Ω –∑–∞–Ω—è—Ç!");
                else {
                    const base = { pass: p, balance: 5000, xp: 0, lvl: 1, gpus: {}, usedPromos: {} };
                    db.ref('users/' + u).set(base).then(() => startApp(u, base));
                }
            }
        });
    }

    function startApp(id, data) {
        user = id;
        document.getElementById('authBox').style.display = 'none';
        document.getElementById('gameApp').style.display = 'grid';
        
        // Listen to User Data
        db.ref('users/' + user).on('value', s => {
            userData = s.val();
            updateSidebar();
        });

        // Listen to Chat
        db.ref('chat').limitToLast(30).on('value', s => {
            const box = document.getElementById('chatBox');
            box.innerHTML = '';
            s.forEach(m => {
                const msg = m.val();
                box.innerHTML += `<div class="chat-msg"><b>${msg.u}:</b> ${msg.t}</div>`;
            });
            box.scrollTop = box.scrollHeight;
        });

        initCrashLoop();
        renderGpus();
        updateTopTable();
        
        // Passive Income Loop
        setInterval(() => {
            let total = 0;
            if(userData.gpus) {
                GPU_DATA.forEach(g => {
                    total += (userData.gpus[g.id] || 0) * g.income;
                });
            }
            if(total > 0) db.ref('users/'+user+'/balance').transaction(b => b + total);
        }, 1000);
    }

    function updateSidebar() {
        document.getElementById('balance').innerText = Math.floor(userData.balance).toLocaleString() + ' ‚ÇΩ';
        const nextXp = userData.lvl * 1000;
        document.getElementById('xpTxt').innerText = `${userData.xp} / ${nextXp} XP`;
        document.getElementById('lvlTxt').innerText = `LEVEL ${userData.lvl}`;
        document.getElementById('xpFill').style.width = (userData.xp / nextXp * 100) + '%';
        document.getElementById('clickVal').innerText = `+${(userData.lvl * 2.5).toFixed(2)} ‚ÇΩ`;
        
        let passive = 0;
        if(userData.gpus) GPU_DATA.forEach(g => passive += (userData.gpus[g.id] || 0) * g.income);
        document.getElementById('passiveVal').innerText = passive + ' ‚ÇΩ/—Å–µ–∫';
    }

    // --- CRASH ENGINE ---
    const cvs = document.getElementById('crashCanvas');
    const ctx = cvs.getContext('2d');

    function initCrashLoop() {
        crash.active = false; crash.mult = 1.0; crash.cashed = false; crash.dots = [];
        const btn = document.getElementById('crashBtn');
        btn.innerText = "–ü–û–°–¢–ê–í–ò–¢–¨ –°–¢–ê–í–ö–£"; btn.className = "btn btn-main"; btn.disabled = false;
        document.getElementById('crashProfit').innerText = '';
        
        let countdown = 8;
        let itv = setInterval(() => {
            countdown--;
            document.getElementById('crashVal').innerText = countdown + 's';
            document.getElementById('crashVal').style.color = '#fff';
            if(countdown <= 0) {
                clearInterval(itv);
                startCrashFlight();
            }
        }, 1000);
    }

    function startCrashFlight() {
        crash.active = true;
        cvs.width = cvs.offsetWidth; cvs.height = cvs.offsetHeight;
        let crashPoint = Math.random() < 0.1 ? 1.0 : (Math.random() * 5 + 1.05);
        let startTime = Date.now();
        
        if(crash.bet > 0) {
            const btn = document.getElementById('crashBtn');
            btn.innerText = "–ó–ê–ë–†–ê–¢–¨"; btn.className = "btn btn-green";
        }

        let flight = setInterval(() => {
            let now = (Date.now() - startTime) / 1000;
            crash.mult = Math.pow(1.08, now).toFixed(2);
            
            // Draw
            ctx.clearRect(0,0,cvs.width, cvs.height);
            ctx.strokeStyle = '#00f2ff'; ctx.lineWidth = 4;
            ctx.shadowBlur = 15; ctx.shadowColor = '#00f2ff';
            
            let x = (now / 10) * cvs.width;
            let y = cvs.height - ((crash.mult - 1) / 4) * cvs.height;
            crash.dots.push({x, y});
            
            ctx.beginPath();
            ctx.moveTo(0, cvs.height);
            crash.dots.forEach(d => ctx.lineTo(d.x, d.y));
            ctx.stroke();

            if(crash.mult >= crashPoint) {
                clearInterval(flight);
                crash.active = false;
                document.getElementById('crashVal').innerText = 'BOOM!';
                document.getElementById('crashVal').style.color = var(--pink);
                playSound(100, 'sawtooth', 0.5);
                crash.bet = 0;
                setTimeout(initCrashLoop, 3000);
            } else {
                document.getElementById('crashVal').innerText = crash.mult + 'x';
                document.getElementById('crashVal').style.color = 'var(--accent)';
                if(crash.bet > 0 && !crash.cashed) {
                    let profit = Math.floor(crash.bet * crash.mult);
                    document.getElementById('crashProfit').innerText = '+' + profit + ' ‚ÇΩ';
                    // Auto cashout
                    let auto = parseFloat(document.getElementById('crashAuto').value);
                    if(auto > 1 && crash.mult >= auto) handleCrash();
                }
            }
        }, 60);
    }

    function handleCrash() {
        if(!crash.active) {
            const b = parseInt(document.getElementById('crashBet').value);
            if(b > 0 && b <= userData.balance) {
                crash.bet = b;
                db.ref('users/'+user+'/balance').transaction(v => v - b);
                document.getElementById('crashBtn').innerText = "–°–¢–ê–í–ö–ê –ü–†–ò–ù–Ø–¢–ê";
                document.getElementById('crashBtn').disabled = true;
                playSound(400);
            }
        } else if(crash.bet > 0 && !crash.cashed) {
            crash.cashed = true;
            let win = Math.floor(crash.bet * crash.mult);
            db.ref('users/'+user).transaction(u => {
                u.balance += win; u.xp += 25;
                return u;
            });
            document.getElementById('crashBtn').innerText = "–í–´–ü–õ–ê–ß–ï–ù–û";
            document.getElementById('crashBtn').disabled = true;
            playSound(800, 'sine', 0.3);
        }
    }

    // --- MINES ---
    function startMines() {
        const b = parseInt(document.getElementById('minesBet').value);
        if(b > 0 && b <= userData.balance) {
            db.ref('users/'+user+'/balance').transaction(v => v - b);
            mines.active = true; mines.bet = b; mines.opened = 0;
            mines.total = parseInt(document.getElementById('minesCount').value);
            mines.bombs = [];
            while(mines.bombs.length < mines.total) {
                let r = Math.floor(Math.random()*25);
                if(!mines.bombs.includes(r)) mines.bombs.push(r);
            }
            renderMines();
            document.getElementById('minesAction').innerText = "–ó–ê–ë–†–ê–¢–¨ (x1.00)";
            document.getElementById('minesAction').onclick = cashMines;
            playSound(500);
        }
    }

    function renderMines() {
        const g = document.getElementById('minesGrid');
        g.innerHTML = '';
        for(let i=0; i<25; i++) {
            const c = document.createElement('div');
            c.className = 'cell';
            c.onclick = () => clickMine(i, c);
            g.appendChild(c);
        }
    }

    function clickMine(i, el) {
        if(!mines.active || el.classList.contains('active')) return;
        if(mines.bombs.includes(i)) {
            mines.active = false;
            el.classList.add('death'); el.innerText = 'üí£';
            playSound(120, 'sawtooth', 0.4);
            setTimeout(() => { resetMines(); alert("–í–ó–†–´–í!"); }, 500);
        } else {
            el.classList.add('active'); el.innerText = 'üíé';
            mines.opened++;
            let m = (1 + (mines.opened * (mines.total/4.5))).toFixed(2);
            document.getElementById('minesAction').innerText = `–ó–ê–ë–†–ê–¢–¨ (x${m})`;
            playSound(600 + (mines.opened * 40));
        }
    }

    function cashMines() {
        if(!mines.active) return;
        let m = (1 + (mines.opened * (mines.total/4.5)));
        let win = Math.floor(mines.bet * m);
        db.ref('users/'+user).transaction(u => { u.balance += win; u.xp += 15; return u; });
        resetMines();
        playSound(900);
    }

    function resetMines() {
        mines.active = false;
        document.getElementById('minesGrid').innerHTML = '';
        document.getElementById('minesAction').innerText = "–ò–ì–†–ê–¢–¨";
        document.getElementById('minesAction').onclick = startMines;
    }

    // --- LADDER ---
    function startLadder() {
        const b = parseInt(document.getElementById('ladderBet').value);
        if(b > 0 && b <= userData.balance) {
            db.ref('users/'+user+'/balance').transaction(v => v - b);
            ladder.active = true; ladder.bet = b; ladder.level = 0;
            renderLadder();
            document.getElementById('ladderStartBtn').innerText = "–í–´–ô–¢–ò (x1.00)";
            document.getElementById('ladderStartBtn').onclick = cashLadder;
            playSound(500);
        }
    }

    function renderLadder() {
        const cont = document.getElementById('ladderGame');
        cont.innerHTML = '';
        for(let i=0; i<8; i++) {
            const row = document.createElement('div');
            row.style = "display:flex; gap:10px;";
            for(let j=0; j<2; j++) {
                const step = document.createElement('div');
                step.className = 'cell';
                step.style = "width:80px; height:40px;";
                if(i === 0) step.onclick = () => clickLadder(j, step, i);
                else step.style.opacity = "0.3";
                row.appendChild(step);
            }
            cont.appendChild(row);
        }
    }

    function clickLadder(choice, el, rowIdx) {
        if(!ladder.active || rowIdx !== ladder.level) return;
        let death = Math.floor(Math.random()*2);
        if(choice === death) {
            el.classList.add('death');
            ladder.active = false;
            playSound(150, 'sawtooth');
            setTimeout(() => { alert("–£–ü–ê–õ!"); renderLadder(); resetLadder(); }, 500);
        } else {
            el.classList.add('active');
            ladder.level++;
            let m = Math.pow(1.9, ladder.level).toFixed(2);
            document.getElementById('ladderStartBtn').innerText = `–ó–ê–ë–†–ê–¢–¨ (x${m})`;
            playSound(700 + (ladder.level * 50));
            // Unlock next row
            const rows = document.getElementById('ladderGame').children;
            if(ladder.level < 8) {
                const nextRow = rows[ladder.level].children;
                for(let s of nextRow) {
                    s.style.opacity = "1";
                    s.onclick = (e) => clickLadder(Array.from(nextRow).indexOf(s), s, ladder.level);
                }
            } else {
                cashLadder(); // Max level auto win
            }
        }
    }

    function cashLadder() {
        if(!ladder.active) return;
        let m = Math.pow(1.9, ladder.level);
        let win = Math.floor(ladder.bet * m);
        db.ref('users/'+user).transaction(u => { u.balance += win; u.xp += 50; return u; });
        resetLadder();
    }

    function resetLadder() {
        ladder.active = false;
        document.getElementById('ladderStartBtn').innerText = "–°–¢–ê–†–¢";
        document.getElementById('ladderStartBtn').onclick = startLadder;
    }

    // --- MINING & GPUS ---
    function manualClick() {
        playSound(300 + (userData.lvl * 20));
        db.ref('users/' + user).transaction(u => {
            if(u) {
                u.balance += (u.lvl * 2.5);
                u.xp += 10;
                if(u.xp >= u.lvl * 1000) {
                    u.lvl++; u.xp = 0;
                    showLvlUp(u.lvl);
                }
            }
            return u;
        });
    }

    function showLvlUp(lvl) {
        const pop = document.getElementById('lvlPopup');
        document.getElementById('newLvlTxt').innerText = lvl;
        pop.style.display = 'flex';
        playSound(1000, 'square', 0.8);
        setTimeout(() => pop.style.display = 'none', 3000);
    }

    function renderGpus() {
        const cont = document.getElementById('gpuContainer');
        cont.innerHTML = '';
        GPU_DATA.forEach(g => {
            const count = (userData.gpus && userData.gpus[g.id]) || 0;
            cont.innerHTML += `
                <div class="case-card" style="display:flex; justify-content:space-between; align-items:center; padding:15px 25px;">
                    <div style="text-align:left">
                        <b style="color:var(--accent)">${g.name}</b><br>
                        <small>–î–æ—Ö–æ–¥: +${g.income}‚ÇΩ/—Å–µ–∫ | –£ –≤–∞—Å: ${count}</small>
                    </div>
                    <button class="btn btn-outline" style="padding:10px 20px;" onclick="buyGpu('${g.id}', ${g.price})">
                        ${(g.price/1000).toFixed(0)}k ‚ÇΩ
                    </button>
                </div>
            `;
        });
    }

    function buyGpu(id, price) {
        if(userData.balance >= price) {
            db.ref('users/'+user).transaction(u => {
                if(u) {
                    u.balance -= price;
                    if(!u.gpus) u.gpus = {};
                    u.gpus[id] = (u.gpus[id] || 0) + 1;
                }
                return u;
            });
            playSound(1200);
            setTimeout(renderGpus, 500);
        } else alert("–ú–∞–ª–æ –¥–µ–Ω–µ–≥!");
    }

    // --- CASES ---
    function openCase(type, price) {
        if(userData.balance < price) return alert("–ú–∞–ª–æ –¥–µ–Ω–µ–≥!");
        db.ref('users/'+user+'/balance').transaction(b => b - price);
        
        const res = document.getElementById('caseResult');
        res.innerText = "–û–¢–ö–†–´–¢–ò–ï...";
        playSound(400, 'square', 1.5, 0.05);

        setTimeout(() => {
            let win = 0;
            if(type === 'common') win = Math.floor(Math.random()*1500);
            if(type === 'rare') win = Math.floor(Math.random()*15000);
            if(type === 'epic') win = Math.floor(Math.random()*200000);
            
            db.ref('users/'+user).transaction(u => { u.balance += win; u.xp += 100; return u; });
            res.innerText = win.toLocaleString() + " ‚ÇΩ";
            res.style.color = win > price ? 'var(--green)' : 'var(--pink)';
            playSound(win > price ? 1000 : 200);
        }, 2000);
    }

    // --- SYSTEM ---
    function sendChat() {
        const t = document.getElementById('chatIn').value.trim();
        if(t && user) {
            db.ref('chat').push({ u: user, t: t });
            document.getElementById('chatIn').value = '';
        }
    }

    function usePromo() {
        const code = document.getElementById('promoIn').value.trim().toUpperCase();
        if(code === 'LEGENDA') {
            if(userData.usedPromos?.LEGENDA) return alert("–£–∂–µ —é–∑–∞–ª!");
            db.ref('users/'+user).transaction(u => {
                u.balance += 10000;
                if(!u.usedPromos) u.usedPromos = {};
                u.usedPromos.LEGENDA = true;
                return u;
            });
            alert("+10,000‚ÇΩ");
        }
        if(code === 'MAKS') {
            const now = Date.now();
            if(now - (userData.lastMaks || 0) < 300000) return alert("–ñ–¥–∏ 5 –º–∏–Ω—É—Ç!");
            db.ref('users/'+user).transaction(u => {
                u.balance += 100; u.lastMaks = now;
                return u;
            });
            alert("+100‚ÇΩ");
        }
    }

    function updateTopTable() {
        db.ref('users').orderByChild('balance').limitToLast(10).on('value', s => {
            const list = document.getElementById('topList');
            list.innerHTML = '';
            let users = [];
            s.forEach(u => users.push({n: u.key, b: u.val().balance}));
            users.reverse().forEach((u, i) => {
                const isTop = i < 3 ? `color:var(--gold); border-color:var(--gold);` : '';
                list.innerHTML += `
                    <div class="chat-msg" style="display:flex; justify-content:space-between; ${isTop}">
                        <span>#${i+1} ${u.n}</span>
                        <b>${Math.floor(u.b).toLocaleString()} ‚ÇΩ</b>
                    </div>
                `;
            });
        });
    }

    function showTab(el, id) {
        document.querySelectorAll('.nav-link, .content').forEach(x => x.classList.remove('active'));
        el.classList.add('active');
        document.getElementById(id).classList.add('active');
        if(id === 'tabMining') renderGpus();
    }
</script>
</body>
</html>
