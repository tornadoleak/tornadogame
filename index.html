<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TORNADO V10.0 | TITAN EDITION</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --accent: #00f2ff; --pink: #ff007b; --gold: #ffcc00; --green: #00ff88;
            --bg: #030507; --card: rgba(10, 15, 20, 0.98); --border: rgba(0, 242, 255, 0.2);
            --neon-glow: 0 0 15px rgba(0, 242, 255, 0.5);
        }

        * { box-sizing: border-box; transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1); outline: none; }
        body {
            font-family: 'Inter', sans-serif; background: var(--bg); color: #fff;
            margin: 0; height: 100vh; display: flex; justify-content: center; align-items: center;
            overflow: hidden;
            background-image: radial-gradient(circle at 50% 50%, #0a1018 0%, #030507 100%);
        }

        .app-container { 
            display: grid; 
            grid-template-columns: 1fr 420px; 
            gap: 25px; 
            width: 98vw; 
            height: 96vh; 
            max-width: 1900px; 
            padding: 15px; 
        }

        .glass-panel { 
            background: var(--card); 
            border: 1px solid var(--border); 
            border-radius: 35px; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            backdrop-filter: blur(30px); 
            box-shadow: 0 25px 80px rgba(0,0,0,0.9); 
        }

        /* --- AUTH SYSTEM --- */
        #authBox { width: 500px; padding: 70px; text-align: center; position: absolute; z-index: 999999; border: 1px solid var(--accent); box-shadow: var(--neon-glow); }
        .auth-nav { display: flex; gap: 15px; margin-bottom: 35px; background: rgba(255,255,255,0.03); padding: 8px; border-radius: 20px; }
        .auth-tab { flex: 1; padding: 15px; border-radius: 15px; cursor: pointer; font-size: 12px; font-weight: 900; color: #5d727b; text-transform: uppercase; letter-spacing: 1px; }
        .auth-tab.active { background: var(--accent); color: #000; box-shadow: var(--neon-glow); }

        /* --- NAVIGATION --- */
        .sidebar-nav { 
            display: flex; 
            background: rgba(0,0,0,0.6); 
            padding: 20px; 
            gap: 12px; 
            border-bottom: 1px solid var(--border); 
            overflow-x: auto; 
            scrollbar-width: none; 
        }
        .nav-btn { 
            padding: 14px 28px; 
            border-radius: 18px; 
            cursor: pointer; 
            font-size: 11px; 
            font-weight: 800; 
            text-transform: uppercase; 
            color: #5d727b; 
            white-space: nowrap; 
            border: 1px solid transparent; 
            background: rgba(255,255,255,0.02);
        }
        .nav-btn.active { 
            background: rgba(0, 242, 255, 0.1); 
            color: var(--accent); 
            border-color: var(--accent); 
            box-shadow: inset 0 0 15px rgba(0, 242, 255, 0.1);
        }

        .viewport { flex: 1; overflow-y: auto; padding: 40px; display: none; flex-direction: column; gap: 30px; }
        .viewport.active { display: flex; animation: viewIn 0.4s ease-out; }
        @keyframes viewIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }

        /* --- CRASH FIX --- */
        .crash-area { 
            height: 420px; 
            background: #020305; 
            border-radius: 30px; 
            position: relative; 
            overflow: hidden; 
            border: 1px solid var(--border); 
        }
        #crashCanvas { width: 100%; height: 100%; }
        .crash-info { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; pointer-events: none; z-index: 100; }
        #crashMult { font-family: 'Orbitron'; font-size: 6.5rem; font-weight: 900; text-shadow: 0 0 50px var(--accent); margin: 0; color: #fff; }
        
        /* --- MINES --- */
        .mines-grid { 
            display: grid; 
            grid-template-columns: repeat(5, 1fr); 
            gap: 18px; 
            width: 100%; 
            max-width: 650px; 
            margin: 0 auto; 
            padding: 25px; 
            background: rgba(0,0,0,0.2);
            border-radius: 30px;
        }
        .game-cell { 
            aspect-ratio: 1; 
            background: rgba(255,255,255,0.03); 
            border: 1px solid var(--border); 
            border-radius: 22px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 36px; 
        }
        .game-cell:hover { background: rgba(0, 242, 255, 0.1); border-color: var(--accent); transform: translateY(-3px); }
        .game-cell.active { background: var(--accent); box-shadow: 0 0 35px var(--accent); color: #000; border: none; }
        .game-cell.death { background: var(--pink); box-shadow: 0 0 35px var(--pink); color: #fff; border: none; }

        /* --- UI ELEMENTS --- */
        .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .field { 
            background: rgba(0,0,0,0.7); 
            border: 1px solid var(--border); 
            padding: 22px; 
            border-radius: 22px; 
            color: #fff; 
            font-family: 'Orbitron'; 
            font-size: 18px; 
            width: 100%; 
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.5);
        }
        .field:focus { border-color: var(--accent); box-shadow: 0 0 15px rgba(0, 242, 255, 0.2); }
        
        .btn-ui { 
            border: none; 
            padding: 24px; 
            border-radius: 22px; 
            font-weight: 900; 
            cursor: pointer; 
            text-transform: uppercase; 
            font-family: 'Orbitron'; 
            font-size: 14px; 
            letter-spacing: 2px; 
        }
        .btn-accent { background: linear-gradient(135deg, var(--accent), #0072ff); color: #000; box-shadow: 0 10px 30px rgba(0, 242, 255, 0.3); }
        .btn-accent:hover { transform: translateY(-2px); box-shadow: 0 15px 40px rgba(0, 242, 255, 0.5); }
        .btn-green { background: linear-gradient(135deg, var(--green), #00b35d); color: #000; box-shadow: 0 10px 30px rgba(0, 255, 136, 0.3); }
        .btn-outline { background: transparent; border: 2px solid var(--border); color: #fff; }
        .btn-outline:hover { border-color: var(--accent); color: var(--accent); }

        /* --- CHAT FIX --- */
        .chat-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: rgba(0,0,0,0.3); border-top: 1px solid var(--border); }
        #chatBox { 
            flex: 1; 
            overflow-y: auto; 
            padding: 25px; 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
            scroll-behavior: smooth;
        }
        .msg { 
            background: rgba(255,255,255,0.04); 
            padding: 14px 20px; 
            border-radius: 20px; 
            font-size: 14px; 
            line-height: 1.5; 
            border-left: 5px solid var(--accent); 
            align-self: flex-start; 
            max-width: 92%; 
            animation: msgIn 0.3s ease;
        }
        @keyframes msgIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        .msg b { color: var(--accent); font-family: 'Orbitron'; font-size: 11px; display: block; margin-bottom: 6px; letter-spacing: 1px; }

        /* --- STATS PANEL --- */
        .user-block { padding: 40px; text-align: center; border-bottom: 1px solid var(--border); background: linear-gradient(180deg, rgba(0,242,255,0.08) 0%, transparent 100%); }
        .bal-display { font-family: 'Orbitron'; font-size: 3rem; font-weight: 900; color: var(--accent); text-shadow: 0 0 20px rgba(0, 242, 255, 0.4); margin-bottom: 15px; }
        .xp-line { height: 12px; background: rgba(255,255,255,0.05); border-radius: 20px; overflow: hidden; margin: 20px 0; border: 1px solid rgba(255,255,255,0.1); }
        .xp-bar { height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent), var(--green)); box-shadow: 0 0 15px var(--accent); transition: 1s cubic-bezier(0.17, 0.67, 0.83, 0.67); }

        /* --- NOTIFICATIONS --- */
        #notif { position: fixed; top: 30px; right: 30px; z-index: 1000000; display: flex; flex-direction: column; gap: 15px; }
        .toast { background: rgba(15, 20, 25, 0.95); border: 1px solid var(--accent); padding: 20px 35px; border-radius: 20px; font-weight: 700; color: #fff; box-shadow: 0 20px 50px rgba(0,0,0,0.5); animation: slideIn 0.4s forwards; }
        @keyframes slideIn { from { transform: translateX(150%); } to { transform: translateX(0); } }

        /* --- LADDER FIX --- */
        .ladder-row { display: flex; gap: 18px; justify-content: center; }
        .ladder-cell { width: 140px; height: 55px; border-radius: 18px; background: rgba(255,255,255,0.03); border: 2px solid var(--border); cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: 900; font-family: 'Orbitron'; font-size: 16px; }
        .ladder-cell.active { background: var(--accent); color: #000; border-color: #fff; box-shadow: var(--neon-glow); }
        .ladder-cell.death { background: var(--pink); border-color: #fff; box-shadow: 0 0 20px var(--pink); }
        .ladder-cell.disabled { opacity: 0.15; cursor: default; }

        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }
    </style>
</head>
<body>

<div id="notif"></div>

<div id="authBox" class="glass-panel">
    <h1 style="font-family:'Orbitron'; font-size: 3rem; margin:0; color:var(--accent); letter-spacing: 5px;">TORNADO</h1>
    <p style="letter-spacing: 12px; font-size: 12px; color: #5d727b; margin-bottom: 40px; font-weight: 900;">TITAN V10.0</p>
    <div class="auth-nav">
        <div class="auth-tab active" id="tabLogin" onclick="setAuth('login')">–í—Ö–æ–¥</div>
        <div class="auth-tab" id="tabReg" onclick="setAuth('reg')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
    </div>
    <input type="text" id="authUser" placeholder="–õ–û–ì–ò–ù" class="field" style="margin-bottom: 20px;">
    <input type="password" id="authPass" placeholder="–ü–ê–†–û–õ–¨" class="field" style="margin-bottom: 35px;">
    <button class="btn-ui btn-accent" style="width:100%" onclick="handleAuth()">–í–û–ô–¢–ò –í –°–ò–°–¢–ï–ú–£</button>
</div>

<div class="app-container" id="mainApp" style="display: none;">
    <div class="glass-panel">
        <div class="sidebar-nav">
            <div class="nav-btn active" onclick="showTab(this, 'viewCrash')">üìà CRASH</div>
            <div class="nav-btn" onclick="showTab(this, 'viewMines')">üí£ MINES</div>
            <div class="nav-btn" onclick="showTab(this, 'viewLadder')">ü™ú LADDER</div>
            <div class="nav-btn" onclick="showTab(this, 'viewMining')">‚ö° MINING</div>
            <div class="nav-btn" onclick="showTab(this, 'viewCases')">üì¶ CASES</div>
            <div class="nav-btn" onclick="showTab(this, 'viewTop')">üèÜ LEADERS</div>
        </div>

        <div id="viewCrash" class="viewport active">
            <div class="crash-area">
                <canvas id="crashCanvas"></canvas>
                <div class="crash-info">
                    <div id="crashMult">1.00x</div>
                    <div id="crashProfit" style="color:var(--green); font-family:'Orbitron'; font-size:2rem; margin-top:10px; height:40px; font-weight:900;"></div>
                </div>
            </div>
            <div class="input-row">
                <input type="number" id="betCrash" placeholder="–°–¢–ê–í–ö–ê (‚ÇΩ)" class="field">
                <input type="number" id="autoCrash" placeholder="–ê–í–¢–û-–í–´–í–û–î" class="field">
            </div>
            <button id="btnCrash" class="btn-ui btn-accent" onclick="actionCrash()">–°–î–ï–õ–ê–¢–¨ –°–¢–ê–í–ö–£</button>
        </div>

        <div id="viewMines" class="viewport">
            <div class="input-row">
                <input type="number" id="betMines" placeholder="–°–¢–ê–í–ö–ê" class="field">
                <select id="cntMines" class="field" style="background:#050709;">
                    <option value="3">3 –ú–ò–ù–´</option>
                    <option value="5">5 –ú–ò–ù</option>
                    <option value="10">10 –ú–ò–ù</option>
                    <option value="24">24 –ú–ò–ù–´</option>
                </select>
            </div>
            <div id="gridMines" class="mines-grid"></div>
            <button id="btnMines" class="btn-ui btn-accent" onclick="startMines()">–ò–ì–†–ê–¢–¨</button>
        </div>

        <div id="viewLadder" class="viewport">
            <div class="input-row">
                <input type="number" id="betLadder" placeholder="–°–¢–ê–í–ö–ê" class="field">
                <select id="stepLadder" class="field" style="background:#050709;">
                    <option value="5">5 –†–Ø–î–û–í</option>
                    <option value="8" selected>8 –†–Ø–î–û–í</option>
                    <option value="12">12 –†–Ø–î–û–í</option>
                </select>
            </div>
            <div id="areaLadder" style="display:flex; flex-direction:column-reverse; gap:12px; margin-top:20px;"></div>
            <button id="startLadder" class="btn-ui btn-accent" onclick="initLadder()">–ù–ê–ß–ê–¢–¨ –ü–û–î–™–ï–ú</button>
        </div>

        <div id="viewMining" class="viewport">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:30px;">
                <button class="btn-ui btn-accent" style="height:200px; font-size:22px;" onclick="clickFarm()">
                    –ë–ò–¢–¨ –ü–û –ë–õ–û–ö–£<br><span id="valClick" style="font-size:12px; opacity:0.7;">+0.00 ‚ÇΩ</span>
                </button>
                <div class="glass-panel" style="justify-content:center; align-items:center; background:rgba(255,255,255,0.02);">
                    <p style="font-size:12px; color:#5d727b; letter-spacing:2px;">–¢–ï–ö–£–©–ò–ô –•–≠–®–†–ï–ô–¢</p>
                    <h1 id="valPassive" style="color:var(--green); font-size:3rem; margin:10px 0;">0 ‚ÇΩ</h1>
                    <p style="font-size:10px;">–í –°–ï–ö–£–ù–î–£</p>
                </div>
            </div>
            <div id="listGPU" style="margin-top:20px; display:flex; flex-direction:column; gap:15px;"></div>
        </div>

        <div id="viewCases" class="viewport">
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:30px;">
                <div class="glass-panel" style="padding:40px; text-align:center; border-color:var(--border);">
                    <h2 style="font-family:'Orbitron'; color:var(--accent);">START</h2>
                    <p style="color:#5d727b; margin-bottom:30px;">–®–∞–Ω—Å –Ω–∞ 10,000 ‚ÇΩ</p>
                    <button id="caseBtn1" class="btn-ui btn-outline" style="width:100%" onclick="openBox(2000, 500, 10000, 'caseBtn1')">2,000 ‚ÇΩ</button>
                </div>
                <div class="glass-panel" style="padding:40px; text-align:center; border-color:var(--gold);">
                    <h2 style="font-family:'Orbitron'; color:var(--gold);">ROYAL</h2>
                    <p style="color:#5d727b; margin-bottom:30px;">–®–∞–Ω—Å –Ω–∞ 250,000 ‚ÇΩ</p>
                    <button id="caseBtn2" class="btn-ui btn-accent" style="width:100%" onclick="openBox(50000, 15000, 250000, 'caseBtn2')">50,000 ‚ÇΩ</button>
                </div>
            </div>
            <h1 id="boxRes" style="text-align:center; font-family:'Orbitron'; margin-top:60px; font-size:4rem; letter-spacing:5px;"></h1>
        </div>

        <div id="viewTop" class="viewport">
            <h1 style="font-family:'Orbitron'; text-align:center; font-size:2.5rem; color:var(--gold);">HALL OF FAME</h1>
            <div id="listTop" style="display:flex; flex-direction:column; gap:15px;"></div>
        </div>
    </div>

    <div class="glass-panel">
        <div class="user-block">
            <div class="bal-display" id="uBalance">0 ‚ÇΩ</div>
            <div class="xp-line"><div class="xp-bar" id="uBar"></div></div>
            <div style="display:flex; justify-content:space-between; font-size:11px; font-weight:900; color:#5d727b;">
                <span id="uLevel">LEVEL 1</span>
                <span id="uXP">0 / 1000 XP</span>
            </div>
        </div>
        <div class="chat-container">
            <div id="chatBox"></div>
            <div style="padding:25px; display:flex; gap:12px; background: rgba(0,0,0,0.5);">
                <input type="text" id="chatInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." class="field" style="padding:15px;">
                <button class="btn-ui btn-accent" style="padding:0 25px;" onclick="sendMsg()">></button>
            </div>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
    // --- DATABASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyC8UkaoaI7nHRSxNPddRwXnNxzHX7kt8s8",
        authDomain: "tornadogame-41ae2.firebaseapp.com",
        databaseURL: "https://tornadogame-41ae2-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "tornadogame-41ae2",
        appId: "1:926174944730:web:20be5b57efb23ab853b4e3"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- STATE ---
    let user = null, userData = {}, authMode = 'login', audio;
    let crash = { active: false, mult: 1.0, bet: 0, cashed: false, pts: [] };
    let mines = { active: false, bet: 0, bombs: [], open: 0, total: 3 };
    let ladder = { active: false, bet: 0, step: 0, max: 8 };
    let isCaseOpening = false;

    const GPUS = [
        {id:'g1', n:'GTX 1050 Ti', p:20000, i:25},
        {id:'g2', n:'RTX 3060', p:120000, i:180},
        {id:'g3', n:'RTX 4090 SUPER', p:2500000, i:4500},
        {id:'g4', n:'ANTMINER S19', p:10000000, i:22000},
        {id:'g5', n:'QUANTUM CORE', p:50000000, i:135000}
    ];

    function sfx(f, t='sine', d=0.15, v=0.08) {
        try {
            if(!audio) audio = new (window.AudioContext || window.webkitAudioContext)();
            const o = audio.createOscillator(); const g = audio.createGain();
            o.type = t; o.frequency.setValueAtTime(f, audio.currentTime);
            g.gain.setValueAtTime(v, audio.currentTime);
            g.gain.exponentialRampToValueAtTime(0.0001, audio.currentTime + d);
            o.connect(g); g.connect(audio.destination); o.start(); o.stop(audio.currentTime + d);
        } catch(e) {}
    }

    function toast(t) {
        const b = document.getElementById('notif');
        const e = document.createElement('div'); e.className = 'toast'; e.innerText = t;
        b.appendChild(e); setTimeout(() => e.remove(), 4000);
    }

    // --- AUTH ---
    function setAuth(m) {
        authMode = m;
        document.getElementById('tabLogin').classList.toggle('active', m==='login');
        document.getElementById('tabReg').classList.toggle('active', m==='reg');
    }

    function handleAuth() {
        const u = document.getElementById('authUser').value.trim().toLowerCase();
        const p = document.getElementById('authPass').value.trim();
        if(u.length < 3) return toast("–õ–æ–≥–∏–Ω –æ—Ç 3 —Å–∏–º–≤–æ–ª–æ–≤!");
        
        db.ref('users/' + u).once('value', s => {
            if(authMode === 'login') {
                if(s.exists() && s.val().pass === p) run(u);
                else toast("–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ!");
            } else {
                if(s.exists()) toast("–õ–æ–≥–∏–Ω –∑–∞–Ω—è—Ç!");
                else db.ref('users/'+u).set({pass:p, balance:15000, xp:0, lvl:1, gpus:{}}).then(()=>run(u));
            }
        });
    }

    function run(id) {
        user = id;
        document.getElementById('authBox').style.display = 'none';
        document.getElementById('mainApp').style.display = 'grid';
        
        // CLEAN CHAT ON START
        document.getElementById('chatBox').innerHTML = '';

        db.ref('users/' + user).on('value', s => {
            userData = s.val();
            updateUI();
        });

        // CHAT ENGINE 10.0
        db.ref('chat').limitToLast(30).on('value', s => {
            const b = document.getElementById('chatBox');
            b.innerHTML = ''; // –ß–∏—Å—Ç–∏–º –ø–µ—Ä–µ–¥ –∫–∞–∂–¥–æ–π –æ—Ç—Ä–∏—Å–æ–≤–∫–æ–π
            s.forEach(m => {
                const msg = document.createElement('div');
                msg.className = 'msg';
                msg.innerHTML = `<b>${m.val().u}</b>${m.val().t}`;
                b.appendChild(msg);
            });
            b.scrollTop = b.scrollHeight;
        });

        initCrash();
        syncTop();

        setInterval(() => {
            let inc = 0; if(userData.gpus) GPUS.forEach(g => inc += (userData.gpus[g.id]||0)*g.i);
            if(inc > 0) db.ref('users/'+user+'/balance').transaction(b => (b||0) + inc);
        }, 1000);
    }

    function updateUI() {
        document.getElementById('uBalance').innerText = Math.floor(userData.balance).toLocaleString() + ' ‚ÇΩ';
        const nx = userData.lvl * 1000;
        document.getElementById('uBar').style.width = (userData.xp / nx * 100) + '%';
        document.getElementById('uLevel').innerText = 'LEVEL ' + userData.lvl;
        document.getElementById('uXP').innerText = `${userData.xp} / ${nx} XP`;
        document.getElementById('valClick').innerText = `+${(userData.lvl * 3).toFixed(2)} ‚ÇΩ`;
        
        let p = 0; if(userData.gpus) GPUS.forEach(g => p += (userData.gpus[g.id]||0)*g.i);
        document.getElementById('valPassive').innerText = p.toLocaleString() + ' ‚ÇΩ';
    }

    // --- CRASH FIX V10 ---
    const cvs = document.getElementById('crashCanvas');
    const ctx = cvs.getContext('2d');
    function initCrash() {
        crash.active = false; crash.mult = 1.0; crash.cashed = false; crash.pts = [];
        const btn = document.getElementById('btnCrash');
        btn.innerText = "–°–î–ï–õ–ê–¢–¨ –°–¢–ê–í–ö–£"; btn.className = 'btn-ui btn-accent'; btn.disabled = false;
        document.getElementById('crashProfit').innerText = '';
        
        let t = 10;
        let itv = setInterval(() => {
            t--; document.getElementById('crashMult').innerText = t + 's';
            if(t <= 0) { clearInterval(itv); startCrash(); }
        }, 1000);
    }

    function startCrash() {
        crash.active = true;
        crash.cashed = false; // Reset cash state
        cvs.width = cvs.offsetWidth; cvs.height = cvs.offsetHeight;
        let boom = Math.random() < 0.08 ? 1.0 : (Math.random() * 8 + 1.1);
        let start = Date.now();
        
        if(crash.bet > 0) {
            const btn = document.getElementById('btnCrash');
            btn.innerText = "–í–´–í–ï–°–¢–ò"; btn.className = 'btn-ui btn-green'; btn.disabled = false;
        }

        let loop = setInterval(() => {
            let now = (Date.now() - start) / 1000;
            crash.mult = Math.pow(1.08, now).toFixed(2);
            
            ctx.clearRect(0,0,cvs.width, cvs.height);
            ctx.strokeStyle = '#00f2ff'; ctx.lineWidth = 6;
            let x = (now / 12) * cvs.width;
            let y = cvs.height - ((crash.mult - 1) / 5) * cvs.height;
            crash.pts.push({x, y});
            ctx.beginPath(); ctx.moveTo(0, cvs.height);
            crash.pts.forEach(p => ctx.lineTo(p.x, p.y)); ctx.stroke();

            if(crash.mult >= boom) {
                clearInterval(loop); crash.active = false;
                document.getElementById('crashMult').innerText = 'CRASHED';
                document.getElementById('crashMult').style.color = 'var(--pink)';
                sfx(80, 'sawtooth', 0.4); 
                crash.bet = 0; 
                setTimeout(() => { document.getElementById('crashMult').style.color = '#fff'; initCrash(); }, 3000);
            } else {
                document.getElementById('crashMult').innerText = crash.mult + 'x';
                if(crash.bet > 0 && !crash.cashed) {
                    document.getElementById('crashProfit').innerText = '+' + Math.floor(crash.bet * crash.mult) + ' ‚ÇΩ';
                    let auto = parseFloat(document.getElementById('autoCrash').value);
                    if(auto > 1 && crash.mult >= auto) actionCrash();
                }
            }
        }, 50);
    }

    function actionCrash() {
        if(!crash.active) {
            let b = parseInt(document.getElementById('betCrash').value);
            if(b > 0 && b <= userData.balance) {
                crash.bet = b; 
                db.ref('users/'+user+'/balance').transaction(v => v - b);
                document.getElementById('btnCrash').innerText = "–û–ñ–ò–î–ê–ù–ò–ï..."; 
                document.getElementById('btnCrash').disabled = true;
            } else toast("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤!");
        } else if(crash.bet > 0 && !crash.cashed) {
            crash.cashed = true;
            let win = Math.floor(crash.bet * crash.mult);
            db.ref('users/'+user).transaction(u => { 
                if(u) { u.balance += win; u.xp += 40; }
                return u; 
            });
            document.getElementById('btnCrash').innerText = "–í–´–ò–ì–†–´–®!";
            document.getElementById('btnCrash').disabled = true;
            document.getElementById('crashProfit').innerText = '';
            sfx(900, 'sine', 0.2);
        }
    }

    // --- LADDER FIXED ---
    function initLadder() {
        let b = parseInt(document.getElementById('betLadder').value);
        if(b > 0 && b <= userData.balance) {
            db.ref('users/'+user+'/balance').transaction(v => v - b);
            ladder.active = true; ladder.bet = b; ladder.step = 0;
            ladder.max = parseInt(document.getElementById('stepLadder').value);
            const area = document.getElementById('areaLadder'); area.innerHTML = '';
            
            for(let i=0; i<ladder.max; i++) {
                const row = document.createElement('div'); row.className = 'ladder-row';
                row.id = `l-row-${i}`;
                for(let j=0; j<2; j++) {
                    const c = document.createElement('div'); c.className = 'ladder-cell';
                    c.innerText = '?';
                    if(i === 0) c.onclick = () => stepLadder(i, c);
                    else c.classList.add('disabled');
                    row.appendChild(c);
                }
                area.appendChild(row);
            }
            document.getElementById('startLadder').innerText = "–ó–ê–ë–†–ê–¢–¨ 1.00x";
            document.getElementById('startLadder').onclick = cashLadder;
        }
    }

    function stepLadder(idx, el) {
        if(!ladder.active || idx !== ladder.step) return;
        if(Math.random() < 0.45) {
            ladder.active = false; el.classList.add('death'); el.innerText = 'BRK';
            sfx(120, 'sawtooth'); setTimeout(resetLadder, 1000);
        } else {
            el.classList.add('active'); el.innerText = 'UP';
            ladder.step++; sfx(600 + (ladder.step*50));
            let m = Math.pow(1.9, ladder.step).toFixed(2);
            document.getElementById('startLadder').innerText = `–ó–ê–ë–†–ê–¢–¨ ${m}x`;
            if(ladder.step < ladder.max) {
                const next = document.getElementById(`l-row-${ladder.step}`);
                Array.from(next.children).forEach(c => {
                    c.classList.remove('disabled');
                    c.onclick = () => stepLadder(ladder.step, c);
                });
            } else cashLadder();
        }
    }

    function cashLadder() {
        if(!ladder.active || ladder.step === 0) return;
        let w = Math.floor(ladder.bet * Math.pow(1.9, ladder.step));
        db.ref('users/'+user).transaction(u => { if(u){u.balance += w; u.xp += 60;} return u; });
        resetLadder(); sfx(1100);
    }
    function resetLadder() { 
        ladder.active = false; 
        document.getElementById('startLadder').innerText = "–ù–ê–ß–ê–¢–¨ –ü–û–î–™–ï–ú"; 
        document.getElementById('startLadder').onclick = initLadder;
    }

    // --- CASE SYSTEM ---
    function openBox(cost, min, max, bid) {
        if(isCaseOpening || userData.balance < cost) return;
        isCaseOpening = true;
        const b = document.getElementById(bid); b.disabled = true; b.style.opacity = "0.5";
        db.ref('users/'+user+'/balance').transaction(v => v - cost);
        const res = document.getElementById('boxRes'); res.innerText = "ROLLING...";
        
        setTimeout(() => {
            let win = Math.floor(Math.random() * (max - min)) + min;
            db.ref('users/'+user).transaction(u => { if(u){u.balance += win; u.xp += 100;} return u; });
            res.innerText = win.toLocaleString() + " ‚ÇΩ";
            res.style.color = win >= cost ? 'var(--green)' : 'var(--pink)';
            isCaseOpening = false; b.disabled = false; b.style.opacity = "1";
            sfx(win > cost ? 1200 : 400);
        }, 1800);
    }

    // --- UTILS ---
    function clickFarm() {
        sfx(400);
        db.ref('users/'+user).transaction(u => {
            if(u) { 
                u.balance += (u.lvl * 3); u.xp += 15;
                if(u.xp >= u.lvl * 1000) { u.lvl++; u.xp = 0; toast("–ù–û–í–´–ô –£–†–û–í–ï–ù–¨!"); }
            }
            return u;
        });
    }

    function sendMsg() {
        let t = document.getElementById('chatInput').value.trim();
        if(t && user) {
            db.ref('chat').push().set({ u: user, t: ": " + t });
            document.getElementById('chatInput').value = '';
        }
    }

    function syncTop() {
        db.ref('users').once('value', s => {
            const list = document.getElementById('listTop'); list.innerHTML = '';
            let users = [];
            s.forEach(u => { users.push({n: u.key, b: u.val().balance}); });
            users.sort((a,b) => b.b - a.b).slice(0, 10).forEach((u, i) => {
                list.innerHTML += `<div class="msg" style="width:100%; border-color:${i==0?'var(--gold)':'var(--accent)'}">
                    <div style="display:flex; justify-content:space-between; width:100%;">
                        <span><b>#${i+1}</b> ${u.n}</span>
                        <span style="color:var(--green)">${Math.floor(u.b).toLocaleString()} ‚ÇΩ</span>
                    </div>
                </div>`;
            });
        });
        setTimeout(syncTop, 20000);
    }

    function showTab(btn, id) {
        document.querySelectorAll('.nav-btn, .viewport').forEach(v => v.classList.remove('active'));
        btn.classList.add('active'); document.getElementById(id).classList.add('active');
        if(id === 'viewMining') syncGPU();
    }

    function syncGPU() {
        const c = document.getElementById('listGPU'); c.innerHTML = '';
        GPUS.forEach(g => {
            let count = (userData.gpus && userData.gpus[g.id]) || 0;
            c.innerHTML += `<div class="glass-panel" style="flex-direction:row; padding:20px; align-items:center; justify-content:space-between;">
                <div><b style="color:var(--accent)">${g.n}</b><br><small>–î–æ—Ö–æ–¥: +${g.i}‚ÇΩ/—Å | –£ –≤–∞—Å: ${count}</small></div>
                <button class="btn-ui btn-outline" style="padding:10px 20px" onclick="buyGPU('${g.id}', ${g.p})">${g.p.toLocaleString()} ‚ÇΩ</button>
            </div>`;
        });
    }
    function buyGPU(id, p) { if(userData.balance >= p) db.ref('users/'+user).transaction(u => { u.balance -= p; if(!u.gpus) u.gpus={}; u.gpus[id] = (u.gpus[id]||0)+1; return u; }); }
</script>
</body>
</html>
