<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TORNADO V10.0 | TITAN MAXIMUM 1000 LINES EDITION</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Montserrat:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        /* --- CORE DESIGN SYSTEM --- */
        :root {
            --accent: #00f2ff;
            --accent-dim: rgba(0, 242, 255, 0.15);
            --pink: #ff007b;
            --gold: #ffcc00;
            --green: #00ff88;
            --bg-deep: #020406;
            --bg-panel: #0a0f14;
            --border-glow: 0 0 15px rgba(0, 242, 255, 0.3);
            --transition-smooth: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Montserrat', sans-serif;
            background: var(--bg-deep);
            color: #ffffff;
            height: 100vh;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #particle-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1; pointer-events: none; opacity: 0.6;
        }

        /* --- LAYOUT STRUCTURE --- */
        .titan-container {
            position: relative;
            z-index: 10;
            width: 98vw;
            height: 96vh;
            display: grid;
            grid-template-columns: 320px 1fr 400px;
            grid-template-rows: 80px 1fr;
            gap: 20px;
            padding: 10px;
        }

        /* --- TOP HEADER --- */
        .titan-header {
            grid-column: 1 / 4;
            background: rgba(10, 15, 20, 0.9);
            border: 1px solid rgba(0, 242, 255, 0.2);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            backdrop-filter: blur(20px);
        }

        .brand { font-family: 'Orbitron'; font-weight: 900; font-size: 32px; color: var(--accent); letter-spacing: 4px; text-shadow: var(--border-glow); }
        .live-stats { display: flex; gap: 40px; font-size: 12px; font-weight: 800; color: #5d727b; text-transform: uppercase; }
        .stat-val { color: #fff; margin-left: 8px; }

        /* --- LEFT SIDEBAR (GAMES NAVIGATION) --- */
        .titan-sidebar {
            grid-row: 2 / 3;
            background: var(--bg-panel);
            border: 1px solid rgba(0, 242, 255, 0.1);
            border-radius: 25px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .nav-item {
            padding: 18px 25px;
            border-radius: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 15px;
            font-weight: 700;
            color: #5d727b;
            transition: var(--transition-smooth);
            border: 1px solid transparent;
            text-transform: uppercase;
            font-size: 13px;
        }

        .nav-item:hover { background: rgba(255,255,255,0.03); color: #fff; }
        .nav-item.active {
            background: var(--accent-dim);
            color: var(--accent);
            border-color: rgba(0, 242, 255, 0.3);
            box-shadow: inset 0 0 20px rgba(0, 242, 255, 0.05);
        }

        /* --- MAIN VIEWPORT --- */
        .titan-viewport {
            grid-row: 2 / 3;
            background: rgba(13, 17, 23, 0.8);
            border-radius: 30px;
            border: 1px solid rgba(0, 242, 255, 0.1);
            overflow-y: auto;
            position: relative;
            padding: 40px;
        }

        .view-content { display: none; animation: fadeIn 0.5s ease; flex-direction: column; gap: 30px; }
        .view-content.active { display: flex; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- CRASH MODULE --- */
        .crash-engine-wrap {
            background: #000;
            height: 450px;
            border-radius: 25px;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.05);
        }

        #crash-canvas { width: 100%; height: 100%; }
        .crash-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; pointer-events: none;
        }
        #crash-multiplier {
            font-family: 'Orbitron'; font-size: 100px; font-weight: 900;
            background: linear-gradient(to bottom, #fff, #5d727b);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        /* --- MINES MODULE --- */
        .mines-grid-container {
            display: grid; grid-template-columns: repeat(5, 1fr);
            gap: 15px; max-width: 550px; margin: 0 auto;
        }
        .mine-cell {
            aspect-ratio: 1; background: #161b22; border-radius: 18px;
            border: 1px solid rgba(255,255,255,0.05); cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 32px; transition: var(--transition-smooth);
        }
        .mine-cell:hover { transform: translateY(-5px); background: #1c2128; border-color: var(--accent); }
        .mine-cell.revealed-gem { background: var(--accent); color: #000; box-shadow: 0 0 30px var(--accent); border: none; }
        .mine-cell.revealed-bomb { background: var(--pink); box-shadow: 0 0 30px var(--pink); border: none; }

        /* --- RIGHT PANEL (USER & CHAT) --- */
        .titan-right-panel {
            grid-row: 2 / 3;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .user-card {
            background: var(--bg-panel); border-radius: 25px; padding: 30px;
            border: 1px solid rgba(0, 242, 255, 0.1);
        }

        .balance-box { margin-bottom: 25px; }
        .balance-label { font-size: 11px; font-weight: 800; color: #5d727b; text-transform: uppercase; letter-spacing: 2px; }
        .balance-amount { font-family: 'Orbitron'; font-size: 36px; color: var(--accent); margin-top: 5px; }

        .xp-system { margin-top: 20px; }
        .xp-header { display: flex; justify-content: space-between; font-size: 11px; font-weight: 900; margin-bottom: 10px; }
        .xp-progress-bg { height: 10px; background: rgba(255,255,255,0.05); border-radius: 5px; overflow: hidden; }
        .xp-progress-fill { height: 100%; width: 45%; background: linear-gradient(90deg, var(--accent), var(--green)); transition: width 1s ease; }

        .chat-module {
            flex: 1; background: var(--bg-panel); border-radius: 25px;
            border: 1px solid rgba(0, 242, 255, 0.1); display: flex; flex-direction: column; overflow: hidden;
        }
        .chat-messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        .message { background: rgba(255,255,255,0.02); padding: 12px 15px; border-radius: 12px; font-size: 13px; line-height: 1.5; border-left: 3px solid var(--accent); }
        .message b { color: var(--accent); display: block; font-size: 10px; text-transform: uppercase; margin-bottom: 4px; }

        .chat-input-wrap { padding: 15px; background: rgba(0,0,0,0.2); display: flex; gap: 10px; }
        .chat-input { flex: 1; background: #161b22; border: 1px solid rgba(255,255,255,0.05); border-radius: 12px; padding: 12px; color: #fff; font-size: 13px; }

        /* --- CONTROLS --- */
        .bet-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .input-group { display: flex; flex-direction: column; gap: 8px; }
        .input-group label { font-size: 10px; font-weight: 900; color: #5d727b; text-transform: uppercase; margin-left: 5px; }
        .titan-input {
            background: #161b22; border: 1px solid rgba(0, 242, 255, 0.1);
            padding: 18px; border-radius: 15px; color: #fff; font-family: 'Orbitron'; font-size: 16px;
        }
        .titan-btn {
            background: var(--accent); color: #000; border: none; padding: 20px;
            border-radius: 15px; font-weight: 900; font-family: 'Orbitron'; cursor: pointer;
            transition: var(--transition-smooth); text-transform: uppercase; letter-spacing: 1px;
        }
        .titan-btn:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(0, 242, 255, 0.3); }
        .titan-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        /* --- AUTH OVERLAY --- */
        #auth-screen {
            position: fixed; inset: 0; background: var(--bg-deep); z-index: 9999;
            display: flex; align-items: center; justify-content: center;
        }
        .auth-card {
            width: 450px; padding: 50px; background: var(--bg-panel); border-radius: 35px;
            border: 1px solid var(--accent); text-align: center; box-shadow: 0 0 100px rgba(0, 242, 255, 0.1);
        }

        /* --- SCROLLBAR --- */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(0, 242, 255, 0.2); border-radius: 10px; }
    </style>
</head>
<body>

<canvas id="particle-canvas"></canvas>

<div id="auth-screen">
    <div class="auth-card">
        <div class="brand" style="margin-bottom: 10px;">TORNADO</div>
        <p style="color: #5d727b; font-size: 12px; margin-bottom: 40px; font-weight: 800; letter-spacing: 5px;">TITAN PROTOCOL V10</p>
        
        <div class="input-group" style="margin-bottom: 20px;">
            <input type="text" id="login-nick" class="titan-input" placeholder="ACCESS IDENTITY" style="text-align: center;">
        </div>
        <div class="input-group" style="margin-bottom: 30px;">
            <input type="password" id="login-pass" class="titan-input" placeholder="SECURITY KEY" style="text-align: center;">
        </div>
        
        <button class="titan-btn" style="width: 100%;" onclick="initTitanSystem()">INITIALIZE SYSTEM</button>
        <p id="auth-status" style="margin-top: 20px; font-size: 11px; color: var(--pink); display: none;">ACCESS DENIED: INVALID KEY</p>
    </div>
</div>

<div class="titan-container" id="main-app" style="display: none;">
    <header class="titan-header">
        <div class="brand">TORNADO</div>
        <div class="live-stats">
            <div>ONLINE TITANS: <span class="stat-val" id="count-online">1,204</span></div>
            <div>TOTAL PAYOUT: <span class="stat-val" style="color: var(--green);">14,502,300 ‚ÇΩ</span></div>
            <div>SYSTEM STATUS: <span class="stat-val" style="color: var(--green);">STABLE</span></div>
        </div>
        <div id="user-identity" style="font-weight: 900; font-size: 14px; color: var(--accent);">GUEST_USER</div>
    </header>

    <aside class="titan-sidebar">
        <div class="nav-item active" onclick="switchView(this, 'crash')">üìà Crash Protocol</div>
        <div class="nav-item" onclick="switchView(this, 'mines')">üí£ Mine Sweep</div>
        <div class="nav-item" onclick="switchView(this, 'ladder')">ü™ú Vertical Ascent</div>
        <div class="nav-item" onclick="switchView(this, 'mining')">‚ö° Core Mining</div>
        <div class="nav-item" onclick="switchView(this, 'cases')">üì¶ Loot Modules</div>
        <div class="nav-item" onclick="switchView(this, 'top')">üèÜ Hall of Fame</div>
        
        <div style="margin-top: auto; padding: 20px; background: rgba(255,0,123,0.05); border-radius: 15px; border: 1px solid rgba(255,0,123,0.2);">
            <p style="font-size: 10px; color: var(--pink); font-weight: 900;">DAILY REWARD</p>
            <p style="font-size: 14px; margin: 5px 0;">5,000.00 ‚ÇΩ</p>
            <button class="titan-btn" style="padding: 10px; font-size: 10px; width: 100%; background: var(--pink);" onclick="claimBonus()">CLAIM</button>
        </div>
    </aside>

    <main class="titan-viewport">
        <div id="view-crash" class="view-content active">
            <div class="crash-engine-wrap">
                <canvas id="crash-canvas"></canvas>
                <div class="crash-overlay">
                    <div id="crash-multiplier">1.00x</div>
                    <div id="crash-state" style="font-weight: 900; color: #5d727b; text-transform: uppercase;">Waiting for Titans...</div>
                </div>
            </div>
            <div class="bet-controls">
                <div class="input-group">
                    <label>Staking Amount</label>
                    <input type="number" id="bet-amount-crash" class="titan-input" value="100">
                </div>
                <div class="input-group">
                    <label>Auto-Withdrawal</label>
                    <input type="number" id="auto-cash-crash" class="titan-input" placeholder="2.00">
                </div>
            </div>
            <button class="titan-btn" id="btn-crash-action" onclick="handleCrashBet()">ENTER PROTOCOL</button>
            <div id="crash-history" style="display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px;"></div>
        </div>

        <div id="view-mines" class="view-content">
            <div class="bet-controls">
                <div class="input-group">
                    <label>Staking Amount</label>
                    <input type="number" id="bet-amount-mines" class="titan-input" value="100">
                </div>
                <div class="input-group">
                    <label>Mine Count</label>
                    <select id="mine-count" class="titan-input" style="background: #161b22;">
                        <option value="3">3 MINES</option>
                        <option value="5">5 MINES</option>
                        <option value="10">10 MINES</option>
                        <option value="24">24 MINES (JACKPOT)</option>
                    </select>
                </div>
            </div>
            <div class="mines-grid-container" id="mines-grid"></div>
            <button class="titan-btn" id="btn-mines-action" onclick="startMinesGame()">INITIALIZE GRID</button>
        </div>

        <div id="view-mining" class="view-content">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="user-card" style="text-align: center; display: flex; flex-direction: column; justify-content: center; height: 300px;">
                    <p class="balance-label">CORE HASH RATE</p>
                    <h2 id="hash-rate-val" style="font-family: 'Orbitron'; font-size: 40px; color: var(--green); margin: 15px 0;">0.00 MH/s</h2>
                    <button class="titan-btn" onclick="manualMine()" style="height: 100px;">MANUAL OVERRIDE (CLICK)</button>
                </div>
                <div class="user-card" style="height: 300px; position: relative; overflow: hidden;">
                    <p class="balance-label">CORE TEMPERATURE</p>
                    <div id="temp-gauge" style="width: 100%; height: 20px; background: #000; margin-top: 20px; border-radius: 10px;">
                        <div id="temp-fill" style="width: 30%; height: 100%; background: var(--accent); transition: 0.3s;"></div>
                    </div>
                    <p id="temp-text" style="margin-top: 10px; font-weight: 900; color: var(--accent);">35.4¬∞C</p>
                </div>
            </div>
            <h3 style="font-family: 'Orbitron'; letter-spacing: 2px; color: #5d727b;">AVAILABLE HARDWARE</h3>
            <div id="mining-shop" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;"></div>
        </div>

        <div id="view-top" class="view-content">
            <h2 style="font-family: 'Orbitron'; text-align: center; font-size: 32px; color: var(--gold);">TITAN HALL OF FAME</h2>
            <div id="leaderboard-list" style="display: flex; flex-direction: column; gap: 10px; margin-top: 30px;"></div>
        </div>
    </main>

    <aside class="titan-right-panel">
        <div class="user-card">
            <div class="balance-box">
                <p class="balance-label">CREDIT BALANCE</p>
                <div class="balance-amount" id="val-balance">0.00 ‚ÇΩ</div>
            </div>
            <div class="xp-system">
                <div class="xp-header">
                    <span id="val-level">LEVEL 1</span>
                    <span id="val-xp-text">450 / 1000 XP</span>
                </div>
                <div class="xp-progress-bg">
                    <div class="xp-progress-fill" id="val-xp-bar"></div>
                </div>
            </div>
        </div>

        <div class="chat-module">
            <div class="chat-messages" id="chat-box"></div>
            <div class="chat-input-wrap">
                <input type="text" id="chat-input" class="chat-input" placeholder="BROADCAST MESSAGE...">
                <button class="titan-btn" style="padding: 10px 20px;" onclick="sendChatMessage()">></button>
            </div>
        </div>
    </aside>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
    // --- FIREBASE CONFIGURATION ---
    const firebaseConfig = {
        apiKey: "AIzaSyC8UkaoaI7nHRSxNPddRwXnNxzHX7kt8s8",
        databaseURL: "https://tornadogame-41ae2-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "tornadogame-41ae2",
        appId: "1:926174944730:web:20be5b57efb23ab853b4e3"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- GLOBAL SYSTEM STATE ---
    let TITAN = {
        user: null,
        data: {
            balance: 0,
            xp: 0,
            lvl: 1,
            mining: { hash: 0, temp: 35, hardware: {} }
        },
        crash: { active: false, multiplier: 1.0, bet: 0, cashed: false, history: [] },
        mines: { active: false, bombs: [], bet: 0, revealed: 0 },
        audio: null
    };

    // --- PARTICLE ENGINE ---
    const pCvs = document.getElementById('particle-canvas');
    const pCtx = pCvs.getContext('2d');
    let particles = [];

    function initParticles() {
        pCvs.width = window.innerWidth;
        pCvs.height = window.innerHeight;
        for(let i=0; i<80; i++) {
            particles.push({
                x: Math.random() * pCvs.width,
                y: Math.random() * pCvs.height,
                size: Math.random() * 2,
                speedY: Math.random() * 0.5 + 0.1,
                opacity: Math.random()
            });
        }
    }

    function animateParticles() {
        pCtx.clearRect(0,0,pCvs.width, pCvs.height);
        pCtx.fillStyle = '#00f2ff';
        particles.forEach(p => {
            p.y -= p.speedY;
            if(p.y < 0) p.y = pCvs.height;
            pCtx.globalAlpha = p.opacity;
            pCtx.beginPath();
            pCtx.arc(p.x, p.y, p.size, 0, Math.PI*2);
            pCtx.fill();
        });
        requestAnimationFrame(animateParticles);
    }
    initParticles(); animateParticles();

    // --- CORE SYSTEM INITIALIZATION ---
    function initTitanSystem() {
        const nick = document.getElementById('login-nick').value.trim();
        const pass = document.getElementById('login-pass').value.trim();
        
        if(nick.length < 3) return;

        db.ref('users/' + nick).once('value', snapshot => {
            if(snapshot.exists()) {
                const data = snapshot.val();
                if(data.pass === pass) {
                    TITAN.user = nick;
                    launchInterface();
                } else {
                    showAuthError();
                }
            } else {
                // Register new Titan
                const newData = {
                    pass: pass,
                    balance: 15000,
                    xp: 0,
                    lvl: 1,
                    hardware: { cpu_v1: 1 }
                };
                db.ref('users/' + nick).set(newData).then(() => {
                    TITAN.user = nick;
                    launchInterface();
                });
            }
        });
    }

    function launchInterface() {
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('main-app').style.display = 'grid';
        document.getElementById('user-identity').innerText = TITAN.user.toUpperCase();
        
        // Listen to Data
        db.ref('users/' + TITAN.user).on('value', snap => {
            TITAN.data = snap.val();
            syncUI();
        });

        // Listen to Chat
        db.ref('chat').limitToLast(30).on('value', snap => {
            const box = document.getElementById('chat-box');
            box.innerHTML = '';
            snap.forEach(m => {
                const msg = document.createElement('div');
                msg.className = 'message';
                msg.innerHTML = `<b>${m.val().user}</b> ${m.val().text}`;
                box.appendChild(msg);
            });
            box.scrollTop = box.scrollHeight;
        });

        initCrashEngine();
        initMiningShop();
        syncLeaderboard();
        startGlobalLoops();
    }

    function syncUI() {
        document.getElementById('val-balance').innerText = Math.floor(TITAN.data.balance).toLocaleString() + ' ‚ÇΩ';
        document.getElementById('val-level').innerText = 'LEVEL ' + TITAN.data.lvl;
        
        const nextXp = TITAN.data.lvl * 1250;
        const progress = (TITAN.data.xp / nextXp) * 100;
        document.getElementById('val-xp-bar').style.width = progress + '%';
        document.getElementById('val-xp-text').innerText = `${TITAN.data.xp} / ${nextXp} XP`;

        // Check Level Up
        if(TITAN.data.xp >= nextXp) {
            db.ref('users/' + TITAN.user).transaction(u => {
                if(u) { u.lvl++; u.xp = 0; u.balance += 5000; }
                return u;
            });
            alert("LEVEL UP! REWARD: 5,000 ‚ÇΩ");
        }
    }

    // --- CRASH ENGINE PROTOCOL ---
    const crashCvs = document.getElementById('crash-canvas');
    const crashCtx = crashCvs.getContext('2d');
    let crashAnimationId;

    function initCrashEngine() {
        crashCvs.width = 800;
        crashCvs.height = 450;
        startCrashCycle();
    }

    function startCrashCycle() {
        TITAN.crash.active = false;
        TITAN.crash.multiplier = 1.0;
        TITAN.crash.cashed = false;
        
        let timer = 8;
        const btn = document.getElementById('btn-crash-action');
        btn.disabled = false;
        btn.innerText = "ENTER PROTOCOL";
        btn.style.background = "var(--accent)";

        let countdown = setInterval(() => {
            timer -= 0.1;
            document.getElementById('crash-state').innerText = `NEXT LAUNCH IN ${timer.toFixed(1)}S`;
            if(timer <= 0) {
                clearInterval(countdown);
                launchCrashRocket();
            }
        }, 100);
    }

    function launchCrashRocket() {
        TITAN.crash.active = true;
        const crashPoint = (Math.random() < 0.1) ? 1.0 : (Math.random() * 5 + 1.05);
        let startTime = Date.now();
        
        if(TITAN.crash.bet > 0) {
            const btn = document.getElementById('btn-crash-action');
            btn.innerText = "WITHDRAW CREDITS";
            btn.style.background = "var(--green)";
        }

        function update() {
            let elapsed = (Date.now() - startTime) / 1000;
            TITAN.crash.multiplier = Math.pow(1.07, elapsed);
            
            document.getElementById('crash-multiplier').innerText = TITAN.crash.multiplier.toFixed(2) + 'x';
            document.getElementById('crash-state').innerText = "TITAN ASCENDING...";
            
            // Draw Chart
            renderCrashChart(elapsed);

            if(TITAN.crash.multiplier >= crashPoint) {
                cancelAnimationFrame(crashAnimationId);
                triggerCrashEnd();
            } else {
                crashAnimationId = requestAnimationFrame(update);
            }
        }
        update();
    }

    function renderCrashChart(elapsed) {
        crashCtx.clearRect(0,0,800,450);
        crashCtx.strokeStyle = '#00f2ff';
        crashCtx.lineWidth = 4;
        crashCtx.shadowBlur = 20;
        crashCtx.shadowColor = '#00f2ff';
        
        crashCtx.beginPath();
        crashCtx.moveTo(0, 450);
        
        for(let i=0; i<elapsed; i += 0.1) {
            let x = (i / 10) * 800;
            let y = 450 - (Math.pow(1.07, i) * 40);
            crashCtx.lineTo(x, y);
        }
        crashCtx.stroke();
    }

    function triggerCrashEnd() {
        TITAN.crash.active = false;
        document.getElementById('crash-multiplier').style.color = "var(--pink)";
        document.getElementById('crash-state').innerText = "CRITICAL FAILURE!";
        
        // Save History
        TITAN.crash.history.unshift(TITAN.crash.multiplier.toFixed(2));
        updateCrashHistoryUI();

        setTimeout(() => {
            document.getElementById('crash-multiplier').style.color = "#fff";
            TITAN.crash.bet = 0;
            startCrashCycle();
        }, 3000);
    }

    function handleCrashBet() {
        if(!TITAN.crash.active) {
            let amt = parseInt(document.getElementById('bet-amount-crash').value);
            if(amt > 0 && amt <= TITAN.data.balance) {
                TITAN.crash.bet = amt;
                db.ref('users/' + TITAN.user + '/balance').transaction(b => b - amt);
                document.getElementById('btn-crash-action').innerText = "READY FOR LAUNCH";
                document.getElementById('btn-crash-action').disabled = true;
            }
        } else {
            if(TITAN.crash.bet > 0 && !TITAN.crash.cashed) {
                TITAN.crash.cashed = true;
                let win = Math.floor(TITAN.crash.bet * TITAN.crash.multiplier);
                db.ref('users/' + TITAN.user).transaction(u => {
                    if(u) { u.balance += win; u.xp += 50; }
                    return u;
                });
                document.getElementById('btn-crash-action').innerText = `+${win} ‚ÇΩ CACHED`;
                document.getElementById('btn-crash-action').disabled = true;
            }
        }
    }

    // --- MINES PROTOCOL ---
    function startMinesGame() {
        if(TITAN.mines.active) return;
        
        let amt = parseInt(document.getElementById('bet-amount-mines').value);
        let mCount = parseInt(document.getElementById('mine-count').value);
        
        if(amt > TITAN.data.balance) return;
        
        TITAN.mines.active = true;
        TITAN.mines.bet = amt;
        TITAN.mines.revealed = 0;
        TITAN.mines.bombs = [];
        
        db.ref('users/' + TITAN.user + '/balance').transaction(b => b - amt);
        
        while(TITAN.mines.bombs.length < mCount) {
            let r = Math.floor(Math.random() * 25);
            if(!TITAN.mines.bombs.includes(r)) TITAN.mines.bombs.push(r);
        }

        const grid = document.getElementById('mines-grid');
        grid.innerHTML = '';
        for(let i=0; i<25; i++) {
            let cell = document.createElement('div');
            cell.className = 'mine-cell';
            cell.onclick = () => revealMine(i, cell);
            grid.appendChild(cell);
        }
        
        document.getElementById('btn-mines-action').innerText = "CASH OUT (1.00x)";
        document.getElementById('btn-mines-action').onclick = cashOutMines;
    }

    function revealMine(idx, el) {
        if(!TITAN.mines.active || el.classList.contains('revealed-gem')) return;
        
        if(TITAN.mines.bombs.includes(idx)) {
            // LOSS
            el.classList.add('revealed-bomb');
            el.innerHTML = 'üí•';
            endMines(false);
        } else {
            // WIN STEP
            el.classList.add('revealed-gem');
            el.innerHTML = 'üíé';
            TITAN.mines.revealed++;
            let currentMult = calculateMinesMult();
            document.getElementById('btn-mines-action').innerText = `CASH OUT (${currentMult}x)`;
        }
    }

    function calculateMinesMult() {
        // Complex formula for mines multiplier
        let n = 25;
        let m = TITAN.mines.bombs.length;
        let r = TITAN.mines.revealed;
        let mult = 1;
        for(let i=0; i<r; i++) {
            mult *= (n - i) / (n - m - i);
        }
        return (mult * 0.98).toFixed(2);
    }

    function cashOutMines() {
        if(TITAN.mines.revealed === 0) return;
        let win = Math.floor(TITAN.mines.bet * calculateMinesMult());
        db.ref('users/' + TITAN.user).transaction(u => {
            if(u) { u.balance += win; u.xp += 30; }
            return u;
        });
        endMines(true);
    }

    function endMines(isWin) {
        TITAN.mines.active = false;
        const grid = document.querySelectorAll('.mine-cell');
        TITAN.mines.bombs.forEach(b => {
            grid[b].classList.add('revealed-bomb');
            grid[b].innerHTML = 'üí•';
        });
        
        setTimeout(() => {
            document.getElementById('mines-grid').innerHTML = '';
            document.getElementById('btn-mines-action').innerText = "INITIALIZE GRID";
            document.getElementById('btn-mines-action').onclick = startMinesGame;
        }, 2000);
    }

    // --- CORE MINING SYSTEM ---
    const HARDWARE = [
        { id: 'cpu_v1', name: 'INTEL CORE i3', price: 5000, power: 2 },
        { id: 'gpu_v1', name: 'GTX 1050 TI', price: 25000, power: 15 },
        { id: 'gpu_v2', name: 'RTX 3060', price: 120000, power: 85 },
        { id: 'asic_v1', name: 'ANTMINER S19', price: 850000, power: 450 },
        { id: 'titan_core', name: 'TITAN QUANTUM CELL', price: 5000000, power: 2800 }
    ];

    function initMiningShop() {
        const shop = document.getElementById('mining-shop');
        shop.innerHTML = '';
        HARDWARE.forEach(h => {
            let card = document.createElement('div');
            card.className = 'user-card';
            card.style.padding = '15px';
            card.innerHTML = `
                <div style="font-weight: 900; font-size: 12px; color: var(--accent);">${h.name}</div>
                <div style="font-size: 10px; color: #5d727b; margin: 5px 0;">Power: +${h.power} MH/s</div>
                <button class="titan-btn" style="padding: 8px; font-size: 10px; width: 100%; margin-top: 10px;" onclick="buyHardware('${h.id}', ${h.price})">BUY FOR ${h.price} ‚ÇΩ</button>
            `;
            shop.appendChild(card);
        });
    }

    function buyHardware(id, price) {
        if(TITAN.data.balance >= price) {
            db.ref('users/' + TITAN.user).transaction(u => {
                if(u) {
                    u.balance -= price;
                    if(!u.hardware) u.hardware = {};
                    u.hardware[id] = (u.hardware[id] || 0) + 1;
                }
                return u;
            });
        }
    }

    function manualMine() {
        db.ref('users/' + TITAN.user).transaction(u => {
            if(u) { u.balance += (u.lvl * 0.5); u.xp += 1; }
            return u;
        });
        // Temp Increase
        TITAN.data.mining.temp += 0.5;
    }

    function startGlobalLoops() {
        // Mining Income Loop
        setInterval(() => {
            let totalPower = 0;
            if(TITAN.data.hardware) {
                HARDWARE.forEach(h => {
                    totalPower += (TITAN.data.hardware[h.id] || 0) * h.power;
                });
            }
            
            if(totalPower > 0) {
                db.ref('users/' + TITAN.user + '/balance').transaction(b => b + (totalPower / 10));
            }
            
            document.getElementById('hash-rate-val').innerText = totalPower.toFixed(2) + ' MH/s';
            
            // Core Cooling
            if(TITAN.data.mining.temp > 35) TITAN.data.mining.temp -= 0.1;
            updateTempUI();
        }, 1000);
    }

    function updateTempUI() {
        const fill = document.getElementById('temp-fill');
        const text = document.getElementById('temp-text');
        let t = TITAN.data.mining.temp;
        fill.style.width = Math.min(t, 100) + '%';
        text.innerText = t.toFixed(1) + '¬∞C';
        
        if(t > 80) fill.style.background = 'var(--pink)';
        else fill.style.background = 'var(--accent)';
    }

    // --- SOCIAL & UI HELPERS ---
    function sendChatMessage() {
        const inp = document.getElementById('chat-input');
        const txt = inp.value.trim();
        if(txt) {
            db.ref('chat').push({ user: TITAN.user, text: txt });
            inp.value = '';
        }
    }

    function switchView(btn, view) {
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        document.querySelectorAll('.view-content').forEach(v => v.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('view-' + view).classList.add('active');
    }

    function syncLeaderboard() {
        db.ref('users').orderByChild('balance').limitToLast(10).on('value', snap => {
            const list = document.getElementById('leaderboard-list');
            list.innerHTML = '';
            let titans = [];
            snap.forEach(u => titans.push({ name: u.key, bal: u.val().balance }));
            titans.reverse().forEach((t, i) => {
                const item = document.createElement('div');
                item.className = 'message';
                item.style.display = 'flex';
                item.style.justifyContent = 'space-between';
                item.innerHTML = `<span>#${i+1} <b>${t.name.toUpperCase()}</b></span> <span style="color:var(--accent)">${Math.floor(t.bal).toLocaleString()} ‚ÇΩ</span>`;
                list.appendChild(item);
            });
        });
    }

    function updateCrashHistoryUI() {
        const hist = document.getElementById('crash-history');
        hist.innerHTML = '';
        TITAN.crash.history.slice(0, 10).forEach(h => {
            const span = document.createElement('span');
            span.style.padding = '5px 15px';
            span.style.background = h >= 2 ? 'rgba(0,255,136,0.1)' : 'rgba(255,0,123,0.1)';
            span.style.color = h >= 2 ? 'var(--green)' : 'var(--pink)';
            span.style.borderRadius = '8px';
            span.style.fontSize = '11px';
            span.style.fontWeight = '900';
            span.innerText = h + 'x';
            hist.appendChild(span);
        });
    }

    function claimBonus() {
        db.ref('users/' + TITAN.user).transaction(u => {
            if(u) u.balance += 5000;
            return u;
        });
        alert("REINFORCEMENTS ARRIVED: +5,000 ‚ÇΩ");
    }

    // --- AUDIO SYSTEM (SIMULATED) ---
    function playSfx(type) {
        // Placeholder for future audio implementation
        console.log("SFX Triggered: " + type);
    }
</script>

</body>
</html>
