<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TORNADO V9.0 | OVERLORD EDITION</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --accent: #00f2ff; --pink: #ff007b; --gold: #ffcc00; --green: #00ff88;
            --bg: #030507; --card: rgba(10, 15, 20, 0.98); --border: rgba(0, 242, 255, 0.15);
        }

        * { box-sizing: border-box; transition: 0.25s cubic-bezier(0.4, 0, 0.2, 1); outline: none; }
        body {
            font-family: 'Inter', sans-serif; background: var(--bg); color: #fff;
            margin: 0; height: 100vh; display: flex; justify-content: center; align-items: center;
            overflow: hidden;
        }

        .app-container { display: grid; grid-template-columns: 1fr 400px; gap: 20px; width: 99vw; height: 98vh; max-width: 1800px; padding: 10px; }
        .glass-panel { background: var(--card); border: 1px solid var(--border); border-radius: 35px; display: flex; flex-direction: column; overflow: hidden; backdrop-filter: blur(30px); box-shadow: 0 25px 80px rgba(0,0,0,0.9); }

        /* Auth Screen */
        #authBox { width: 480px; padding: 60px; text-align: center; position: absolute; z-index: 10000; box-shadow: 0 0 150px rgba(0, 242, 255, 0.15); }
        .auth-nav { display: flex; gap: 10px; margin-bottom: 30px; background: rgba(0,0,0,0.5); padding: 6px; border-radius: 20px; }
        .auth-tab { flex: 1; padding: 12px; border-radius: 15px; cursor: pointer; font-size: 11px; font-weight: 900; color: #5d727b; text-transform: uppercase; }
        .auth-tab.active { background: var(--accent); color: #000; box-shadow: 0 0 20px rgba(0, 242, 255, 0.4); }

        /* Navigation */
        .sidebar-nav { display: flex; background: rgba(0,0,0,0.6); padding: 15px; gap: 10px; border-bottom: 1px solid var(--border); overflow-x: auto; scrollbar-width: none; }
        .nav-btn { padding: 12px 24px; border-radius: 18px; cursor: pointer; font-size: 10px; font-weight: 900; text-transform: uppercase; color: #5d727b; white-space: nowrap; border: 1px solid transparent; }
        .nav-btn.active { background: rgba(0, 242, 255, 0.08); color: var(--accent); border-color: var(--border); }

        .viewport { flex: 1; overflow-y: auto; padding: 30px; display: none; flex-direction: column; gap: 25px; scrollbar-width: thin; }
        .viewport.active { display: flex; animation: fadeInUp 0.5s both; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Crash Grid */
        .crash-box { height: 380px; background: #050709; border-radius: 30px; position: relative; overflow: hidden; border: 1px solid var(--border); }
        #crashCanvas { width: 100%; height: 100%; }
        .crash-info { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; pointer-events: none; z-index: 10; }
        #crashMult { font-family: 'Orbitron'; font-size: 6rem; font-weight: 900; text-shadow: 0 0 50px var(--accent); margin: 0; line-height: 1; }
        #crashCash { color: var(--green); font-size: 1.8rem; font-weight: 800; font-family: 'Orbitron'; height: 40px; margin-top: 10px; }

        /* Inputs & Buttons */
        .input-group { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .input-field { background: rgba(0,0,0,0.7); border: 1px solid var(--border); padding: 20px; border-radius: 22px; color: #fff; font-family: 'Orbitron'; font-size: 18px; width: 100%; }
        .input-field:focus { border-color: var(--accent); box-shadow: 0 0 15px rgba(0, 242, 255, 0.1); }
        .main-btn { border: none; padding: 22px; border-radius: 22px; font-weight: 900; cursor: pointer; text-transform: uppercase; font-family: 'Orbitron'; font-size: 14px; letter-spacing: 1px; }
        .btn-accent { background: linear-gradient(135deg, var(--accent), #0072ff); color: #000; }
        .btn-green { background: linear-gradient(135deg, var(--green), #00b35d); color: #000; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: #fff; }
        .btn-outline:hover { background: rgba(255,255,255,0.05); }

        /* Game Elements */
        .mines-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; max-width: 500px; margin: 0 auto; }
        .game-cell { aspect-ratio: 1; background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 28px; }
        .game-cell:hover { background: rgba(0, 242, 255, 0.1); transform: translateY(-3px); }
        .game-cell.active { background: var(--accent); box-shadow: 0 0 30px var(--accent); color: #000; border: none; }
        .game-cell.death { background: var(--pink); box-shadow: 0 0 30px var(--pink); color: #fff; border: none; }

        /* Mining Cards */
        .gpu-card { background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 25px; padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .gpu-info b { color: var(--accent); font-size: 18px; display: block; margin-bottom: 5px; }
        .gpu-info span { font-size: 12px; color: #5d727b; }

        /* Case Cards */
        .case-box { background: linear-gradient(180deg, rgba(255,255,255,0.03) 0%, transparent 100%); border: 1px solid var(--border); border-radius: 30px; padding: 30px; text-align: center; }
        .case-range { font-size: 11px; color: var(--gold); margin: 15px 0; font-family: 'Orbitron'; opacity: 0.8; }

        /* Sidebar UI */
        .stat-card { padding: 35px; text-align: center; border-bottom: 1px solid var(--border); }
        .balance-val { font-family: 'Orbitron'; font-size: 2.8rem; font-weight: 900; color: var(--accent); letter-spacing: -1px; }
        .xp-container { margin-top: 20px; }
        .xp-track { height: 12px; background: rgba(255,255,255,0.05); border-radius: 20px; overflow: hidden; margin-bottom: 8px; }
        .xp-fill { height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent), var(--pink)); box-shadow: 0 0 15px var(--accent); }

        /* Chat System */
        .chat-wrap { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        #chatDisplay { flex: 1; overflow-y: auto; padding: 25px; display: flex; flex-direction: column; gap: 12px; }
        .message { background: rgba(255,255,255,0.02); padding: 15px; border-radius: 20px; font-size: 13px; border-left: 4px solid var(--border); }
        .message b { color: var(--accent); font-family: 'Orbitron'; font-size: 10px; display: block; margin-bottom: 5px; text-transform: uppercase; }

        /* Notifications */
        #notifArea { position: fixed; top: 25px; right: 25px; z-index: 100000; display: flex; flex-direction: column; gap: 12px; }
        .toast { background: var(--card); border: 1px solid var(--accent); padding: 20px 30px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); animation: slideLeft 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28) forwards; }
        @keyframes slideLeft { from { transform: translateX(120%); } to { transform: translateX(0); } }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }
    </style>
</head>
<body>

<div id="notifArea"></div>

<div id="authBox" class="glass-panel">
    <h1 style="font-family:'Orbitron'; font-size: 2.8rem; margin:0; color:var(--accent);">TORNADO</h1>
    <p style="letter-spacing: 10px; font-size: 10px; color: #5d727b; margin-bottom: 40px;">OVERLORD V9.0</p>
    
    <div class="auth-nav">
        <div class="auth-tab active" id="modeL" onclick="setAuth('login')">–í–•–û–î</div>
        <div class="auth-tab" id="modeR" onclick="setAuth('reg')">–†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø</div>
    </div>
    
    <input type="text" id="userIn" placeholder="–õ–û–ì–ò–ù" class="input-field" style="margin-bottom: 15px;">
    <input type="password" id="passIn" placeholder="–ü–ê–†–û–õ–¨" class="input-field" style="margin-bottom: 35px;">
    <button class="main-btn btn-accent" style="width: 100%;" onclick="processAuth()">–ü–û–î–¢–í–ï–†–î–ò–¢–¨</button>
</div>

<div class="app-container" id="appFrame" style="display: none;">
    <div class="glass-panel">
        <div class="sidebar-nav">
            <div class="nav-btn active" onclick="tab(this, 'vCrash')">CRASH</div>
            <div class="nav-btn" onclick="tab(this, 'vMines')">MINES</div>
            <div class="nav-btn" onclick="tab(this, 'vLadder')">LADDER</div>
            <div class="nav-btn" onclick="tab(this, 'vMining')">MINING</div>
            <div class="nav-btn" onclick="tab(this, 'vCases')">CASES</div>
            <div class="nav-btn" onclick="tab(this, 'vTop')">LEADERS</div>
        </div>

        <div id="vCrash" class="viewport active">
            <div class="crash-box">
                <canvas id="crashCanvas"></canvas>
                <div class="crash-info">
                    <div id="crashMult">1.00x</div>
                    <div id="crashCash"></div>
                </div>
            </div>
            <div class="input-group">
                <input type="number" id="cBet" placeholder="–°–¢–ê–í–ö–ê" class="input-field">
                <input type="number" id="cAuto" placeholder="–ê–í–¢–û (2.0)" class="input-field">
            </div>
            <button id="cBtn" class="main-btn btn-accent" onclick="handleCrash()">–ü–û–°–¢–ê–í–ò–¢–¨</button>
        </div>

        <div id="vMines" class="viewport">
            <div class="input-group">
                <input type="number" id="mBet" placeholder="–°–¢–ê–í–ö–ê" class="input-field">
                <select id="mCount" class="input-field" style="background:#000;">
                    <option value="3">3 –ú–ò–ù–´</option>
                    <option value="5">5 –ú–ò–ù</option>
                    <option value="12">12 –ú–ò–ù</option>
                    <option value="24">24 –ú–ò–ù–´</option>
                </select>
            </div>
            <div id="mGrid" class="mines-grid"></div>
            <button id="mAction" class="main-btn btn-accent" onclick="startMines()">–ò–ì–†–ê–¢–¨</button>
        </div>

        <div id="vLadder" class="viewport">
            <div class="input-group" style="grid-template-columns: 1fr 1fr 1fr;">
                <input type="number" id="lBet" placeholder="–°–¢–ê–í–ö–ê" class="input-field">
                <select id="lSteps" class="input-field" style="background:#000;">
                    <option value="5">5 –°–¢–£–ü–ï–ù–ï–ô</option>
                    <option value="8" selected>8 –°–¢–£–ü–ï–ù–ï–ô</option>
                    <option value="12">12 –°–¢–£–ü–ï–ù–ï–ô</option>
                </select>
                <button id="lStart" class="main-btn btn-accent" onclick="startLadder()">–°–¢–ê–†–¢</button>
            </div>
            <div id="lArea" style="display:flex; flex-direction:column-reverse; gap:12px; align-items:center;"></div>
        </div>

        <div id="vMining" class="viewport">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:25px;">
                <button class="main-btn btn-accent" style="height:180px;" onclick="doManualMine()">
                    <span style="font-size:30px;">MINE</span><br>
                    <span id="clickPower" style="font-size:12px; opacity:0.6;">+2.50 ‚ÇΩ</span>
                </button>
                <div class="glass-panel" style="justify-content:center; align-items:center; background:rgba(0,0,0,0.4);">
                    <p style="font-size:11px; color:#5d727b; margin:0; text-transform:uppercase;">Passive Income</p>
                    <h1 id="passiveRate" style="color:var(--green); font-family:'Orbitron'; margin:10px 0;">0 ‚ÇΩ/—Å–µ–∫</h1>
                </div>
            </div>
            <h2 style="font-family:'Orbitron'; margin-top:30px;">MARKETPLACE</h2>
            <div id="gpuContainer" style="display:grid; gap:15px;"></div>
        </div>

        <div id="vCases" class="viewport">
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:25px;">
                <div class="case-box">
                    <h3>–ë–û–ú–ñ-–ü–ê–ö–ï–¢</h3>
                    <div class="case-range">–í–´–ü–ê–î–ï–¢: 100 ‚ÇΩ ‚Äî 2,500 ‚ÇΩ</div>
                    <button class="main-btn btn-outline" style="width:100%" onclick="openCase(1000, 100, 2500)">1,000 ‚ÇΩ</button>
                </div>
                <div class="case-box" style="border-color:var(--accent);">
                    <h3 style="color:var(--accent);">–ë–ò–ó–ù–ï–°-–õ–ê–ù–ß</h3>
                    <div class="case-range">–í–´–ü–ê–î–ï–¢: 5,000 ‚ÇΩ ‚Äî 100,000 ‚ÇΩ</div>
                    <button class="main-btn btn-outline" style="width:100%" onclick="openCase(25000, 5000, 100000)">25,000 ‚ÇΩ</button>
                </div>
                <div class="case-box" style="border-color:var(--gold);">
                    <h3 style="color:var(--gold);">–û–õ–ò–ì–ê–†–•</h3>
                    <div class="case-range">–í–´–ü–ê–î–ï–¢: 50,000 ‚ÇΩ ‚Äî 1,500,000 ‚ÇΩ</div>
                    <button class="main-btn btn-accent" style="width:100%" onclick="openCase(250000, 50000, 1500000)">250,000 ‚ÇΩ</button>
                </div>
            </div>
            <div id="caseResult" style="text-align:center; font-family:'Orbitron'; font-size:3rem; margin-top:40px;"></div>
        </div>

        <div id="vTop" class="viewport">
            <h1 style="font-family:'Orbitron'; text-align:center;">GLOBAL LEADERS</h1>
            <div id="leaderboard" style="display:flex; flex-direction:column; gap:12px;"></div>
        </div>
    </div>

    <div class="glass-panel">
        <div class="stat-card">
            <div class="balance-val" id="balText">0 ‚ÇΩ</div>
            <div class="xp-container">
                <div class="xp-track"><div class="xp-fill" id="xpFill"></div></div>
                <div style="display:flex; justify-content:space-between; font-size:11px; font-weight:800; color:#5d727b;">
                    <span id="lvlText">LVL 1</span><span id="xpText">0 / 1000</span>
                </div>
            </div>
        </div>
        <div class="chat-wrap">
            <div id="chatDisplay"></div>
            <div style="padding:25px; background:rgba(0,0,0,0.4); display:flex; gap:12px;">
                <input type="text" id="chatInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." style="font-size:14px; padding:15px; border-radius:15px;" class="input-field">
                <button class="main-btn btn-accent" style="padding:0 25px; border-radius:15px;" onclick="pushChat()">></button>
            </div>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
    // --- DATABASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyC8UkaoaI7nHRSxNPddRwXnNxzHX7kt8s8",
        authDomain: "tornadogame-41ae2.firebaseapp.com",
        databaseURL: "https://tornadogame-41ae2-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "tornadogame-41ae2",
        appId: "1:926174944730:web:20be5b57efb23ab853b4e3"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- GAME ENGINE STATE ---
    let user = null, userData = {}, authMode = 'login', audio;
    let crash = { active: false, mult: 1.0, bet: 0, cashed: false, pts: [] };
    let mines = { active: false, bet: 0, bombs: [], open: 0, total: 3 };
    let ladder = { active: false, bet: 0, step: 0, maxSteps: 8 };

    const GPUS = [
        {id:'gpu1', n:'GTX 1650 Super', p:25000, i:25},
        {id:'gpu2', n:'RTX 3070 Ti', p:120000, i:140},
        {id:'gpu3', n:'RTX 4090 OC', p:750000, i:950},
        {id:'gpu4', n:'A100 Tensor Core', p:3500000, i:5200},
        {id:'gpu5', n:'H100 NVL Server', p:12000000, i:22000},
        {id:'gpu6', n:'Quantum Core Q1', p:95000000, i:185000}
    ];

    // --- UTILS & AUDIO ---
    function playSfx(freq, type='sine', dur=0.15, vol=0.08) {
        try {
            if(!audio) audio = new (window.AudioContext || window.webkitAudioContext)();
            const o = audio.createOscillator(); const g = audio.createGain();
            o.type = type; o.frequency.setValueAtTime(freq, audio.currentTime);
            g.gain.setValueAtTime(vol, audio.currentTime);
            g.gain.exponentialRampToValueAtTime(0.0001, audio.currentTime + dur);
            o.connect(g); g.connect(audio.destination); o.start(); o.stop(audio.currentTime + dur);
        } catch(e) {}
    }

    function notify(text) {
        const area = document.getElementById('notifArea');
        const t = document.createElement('div'); t.className = 'toast'; t.innerText = text;
        area.appendChild(t); setTimeout(() => t.remove(), 4000);
    }

    // --- AUTHORIZATION ---
    function setAuth(m) {
        authMode = m;
        document.getElementById('modeL').classList.toggle('active', m==='login');
        document.getElementById('modeR').classList.toggle('active', m==='reg');
    }

    function processAuth() {
        const u = document.getElementById('userIn').value.trim().toLowerCase();
        const p = document.getElementById('passIn').value.trim();
        if(u.length < 3 || p.length < 3) return notify("–õ–æ–≥–∏–Ω/–ü–∞—Ä–æ–ª—å —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–µ!");

        db.ref('users/' + u).once('value', s => {
            if(authMode === 'login') {
                if(s.exists() && s.val().pass === p) startApp(u, s.val());
                else notify("–û—à–∏–±–∫–∞: –ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ!");
            } else {
                if(s.exists()) notify("–û—à–∏–±–∫–∞: –õ–æ–≥–∏–Ω –∑–∞–Ω—è—Ç!");
                else {
                    const base = { pass: p, balance: 5000, xp: 0, lvl: 1, gpus: {} };
                    db.ref('users/' + u).set(base).then(() => startApp(u, base));
                }
            }
        });
    }

    function startApp(id, data) {
        user = id;
        document.getElementById('authBox').style.display = 'none';
        document.getElementById('appFrame').style.display = 'grid';
        
        db.ref('users/' + user).on('value', s => {
            userData = s.val();
            updateSidebar();
        });

        db.ref('chat').limitToLast(40).on('value', s => {
            const display = document.getElementById('chatDisplay');
            display.innerHTML = '';
            s.forEach(m => {
                const val = m.val();
                display.innerHTML += `<div class="message"><b>${val.u}</b>${val.t}</div>`;
            });
            display.scrollTop = display.scrollHeight;
        });

        initCrashEngine();
        updateMarket();
        initLeaderboard();
        
        // Passive Loop
        setInterval(() => {
            let total = 0;
            if(userData.gpus) GPUS.forEach(g => total += (userData.gpus[g.id] || 0) * g.i);
            if(total > 0) db.ref('users/'+user+'/balance').transaction(b => (b || 0) + total);
        }, 1000);
        
        notify("–î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω. –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!");
    }

    function updateSidebar() {
        document.getElementById('balText').innerText = Math.floor(userData.balance).toLocaleString() + ' ‚ÇΩ';
        const nextXp = userData.lvl * 1000;
        document.getElementById('xpFill').style.width = (userData.xp / nextXp * 100) + '%';
        document.getElementById('lvlText').innerText = 'LVL ' + userData.lvl;
        document.getElementById('xpText').innerText = `${userData.xp} / ${nextXp}`;
        document.getElementById('clickPower').innerText = `+${(userData.lvl * 2.5).toFixed(2)} ‚ÇΩ`;
        
        let rate = 0; if(userData.gpus) GPUS.forEach(g => rate += (userData.gpus[g.id] || 0) * g.i);
        document.getElementById('passiveRate').innerText = rate.toLocaleString() + ' ‚ÇΩ/—Å–µ–∫';
    }

    // --- CRASH LOGIC ---
    const canvas = document.getElementById('crashCanvas');
    const ctx = canvas.getContext('2d');

    function initCrashEngine() {
        crash.active = false; crash.mult = 1.0; crash.cashed = false; crash.pts = [];
        const btn = document.getElementById('cBtn');
        btn.innerText = "–°–î–ï–õ–ê–¢–¨ –°–¢–ê–í–ö–£"; btn.disabled = false; btn.className = 'main-btn btn-accent';
        document.getElementById('crashCash').innerText = '';
        
        let timer = 10;
        let countdown = setInterval(() => {
            timer--;
            document.getElementById('crashMult').innerText = timer + 's';
            document.getElementById('crashMult').style.color = '#fff';
            if(timer <= 0) { clearInterval(countdown); startCrashRun(); }
        }, 1000);
    }

    function startCrashRun() {
        crash.active = true;
        canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight;
        let crashPoint = Math.random() < 0.12 ? 1.0 : (Math.random() * 6 + 1.02);
        let startTime = Date.now();
        
        if(crash.bet > 0) {
            document.getElementById('cBtn').innerText = "–í–´–í–ï–°–¢–ò";
            document.getElementById('cBtn').className = 'main-btn btn-green';
        }

        let animator = setInterval(() => {
            let elapsed = (Date.now() - startTime) / 1000;
            crash.mult = Math.pow(1.085, elapsed).toFixed(2);
            
            ctx.clearRect(0,0,canvas.width, canvas.height);
            ctx.strokeStyle = '#00f2ff'; ctx.lineWidth = 6;
            ctx.shadowBlur = 20; ctx.shadowColor = '#00f2ff';
            
            let x = (elapsed / 12) * canvas.width;
            let y = canvas.height - ((crash.mult - 1) / 5) * canvas.height;
            crash.pts.push({x, y});
            
            ctx.beginPath(); ctx.moveTo(0, canvas.height);
            crash.pts.forEach(p => ctx.lineTo(p.x, p.y)); ctx.stroke();

            if(crash.mult >= crashPoint) {
                clearInterval(animator); crash.active = false;
                document.getElementById('crashMult').innerText = 'BOOM!';
                document.getElementById('crashMult').style.color = 'var(--pink)';
                playSfx(120, 'sawtooth', 0.5); crash.bet = 0;
                setTimeout(initCrashEngine, 3500);
            } else {
                document.getElementById('crashMult').innerText = crash.mult + 'x';
                document.getElementById('crashMult').style.color = 'var(--accent)';
                if(crash.bet > 0 && !crash.cashed) {
                    let win = Math.floor(crash.bet * crash.mult);
                    document.getElementById('crashCash').innerText = '+' + win.toLocaleString() + ' ‚ÇΩ';
                    let auto = parseFloat(document.getElementById('cAuto').value);
                    if(auto > 1 && crash.mult >= auto) handleCrash();
                }
            }
        }, 50);
    }

    function handleCrash() {
        if(!crash.active) {
            const b = parseInt(document.getElementById('cBet').value);
            if(b > 0 && b <= userData.balance) {
                crash.bet = b; db.ref('users/'+user+'/balance').transaction(v => v - b);
                document.getElementById('cBtn').innerText = "–í –ò–ì–†–ï";
                document.getElementById('cBtn').disabled = true;
                playSfx(440);
            }
        } else if(crash.bet > 0 && !crash.cashed) {
            crash.cashed = true;
            let win = Math.floor(crash.bet * crash.mult);
            db.ref('users/'+user).transaction(u => { u.balance += win; u.xp += 30; return u; });
            document.getElementById('cBtn').innerText = "–í–´–ü–õ–ê–ß–ï–ù–û";
            document.getElementById('cBtn').disabled = true;
            playSfx(880, 'sine', 0.4);
        }
    }

    // --- MINES LOGIC ---
    function startMines() {
        const b = parseInt(document.getElementById('mBet').value);
        if(b > 0 && b <= userData.balance) {
            db.ref('users/'+user+'/balance').transaction(v => v - b);
            mines.active = true; mines.bet = b; mines.open = 0;
            mines.total = parseInt(document.getElementById('mCount').value);
            mines.bombs = [];
            while(mines.bombs.length < mines.total) {
                let r = Math.floor(Math.random()*25);
                if(!mines.bombs.includes(r)) mines.bombs.push(r);
            }
            const grid = document.getElementById('mGrid'); grid.innerHTML = '';
            for(let i=0; i<25; i++) {
                const cell = document.createElement('div'); cell.className = 'game-cell';
                cell.onclick = () => {
                    if(!mines.active || cell.classList.contains('active')) return;
                    if(mines.bombs.includes(i)) {
                        mines.active = false; cell.classList.add('death'); cell.innerText = 'üí£';
                        playSfx(100, 'sawtooth'); setTimeout(() => { notify("–í–ó–†–´–í!"); grid.innerHTML = ''; resetMinesUI(); }, 700);
                    } else {
                        cell.classList.add('active'); cell.innerText = 'üíé'; mines.open++;
                        playSfx(500 + (mines.open * 60));
                        let m = (1 + (mines.open * (mines.total/3.5))).toFixed(2);
                        document.getElementById('mAction').innerText = `–ó–ê–ë–†–ê–¢–¨ (${m}x)`;
                    }
                };
                grid.appendChild(cell);
            }
            document.getElementById('mAction').innerText = "–ó–ê–ë–†–ê–¢–¨ (1.00x)";
            document.getElementById('mAction').onclick = () => {
                if(!mines.active || mines.open === 0) return;
                let mult = (1 + (mines.open * (mines.total/3.5)));
                let win = Math.floor(mines.bet * mult);
                db.ref('users/'+user).transaction(u => { u.balance += win; u.xp += 20; return u; });
                grid.innerHTML = ''; resetMinesUI(); playSfx(1200, 'sine', 0.4);
            };
        }
    }
    function resetMinesUI() {
        mines.active = false; document.getElementById('mAction').innerText = "–ò–ì–†–ê–¢–¨";
        document.getElementById('mAction').onclick = startMines;
    }

    // --- LADDER LOGIC ---
    function startLadder() {
        const b = parseInt(document.getElementById('lBet').value);
        if(b > 0 && b <= userData.balance) {
            db.ref('users/'+user+'/balance').transaction(v => v - b);
            ladder.active = true; ladder.bet = b; ladder.step = 0;
            ladder.maxSteps = parseInt(document.getElementById('lSteps').value);
            const area = document.getElementById('lArea'); area.innerHTML = '';
            for(let i=0; i<ladder.maxSteps; i++) {
                const row = document.createElement('div'); row.style = "display:flex; gap:15px;";
                for(let j=0; j<2; j++) {
                    const step = document.createElement('div'); step.className = 'game-cell';
                    step.style = "width:110px; height:50px;";
                    if(i === 0) step.onclick = () => handleLadderStep(j, step, i);
                    else step.style.opacity = "0.2";
                    row.appendChild(step);
                }
                area.appendChild(row);
            }
            document.getElementById('lStart').innerText = "CASH (1.0x)";
            document.getElementById('lStart').onclick = cashLadder;
        }
    }

    function handleLadderStep(choice, el, idx) {
        if(!ladder.active || idx !== ladder.step) return;
        if(Math.random() < 0.52) { // 52% chance to lose (slight house edge)
            ladder.active = false; el.classList.add('death'); playSfx(140, 'sawtooth');
            setTimeout(() => { notify("–ü–ê–î–ï–ù–ò–ï!"); startLadder(); resetLadderUI(); }, 600);
        } else {
            el.classList.add('active'); ladder.step++;
            playSfx(600 + (ladder.step * 70));
            let m = Math.pow(1.95, ladder.step).toFixed(2);
            document.getElementById('lStart').innerText = `CASH (${m}x)`;
            const rows = document.getElementById('lArea').children;
            if(ladder.step < ladder.maxSteps) {
                Array.from(rows[ladder.step].children).forEach((s, k) => {
                    s.style.opacity = "1"; s.onclick = () => handleLadderStep(k, s, ladder.step);
                });
            } else { cashLadder(); }
        }
    }

    function cashLadder() {
        if(!ladder.active) return;
        let win = Math.floor(ladder.bet * Math.pow(1.95, ladder.step));
        db.ref('users/'+user).transaction(u => { u.balance += win; u.xp += 50; return u; });
        resetLadderUI(); playSfx(1500, 'sine', 0.5); notify("–ó–∞–±—Ä–∞–ª: " + win + " ‚ÇΩ");
    }
    function resetLadderUI() {
        ladder.active = false; document.getElementById('lStart').innerText = "–°–¢–ê–†–¢";
        document.getElementById('lStart').onclick = startLadder;
    }

    // --- MINING & CASES ---
    function doManualMine() {
        playSfx(300 + (userData.lvl * 25));
        db.ref('users/'+user).transaction(u => {
            if(u) {
                u.balance += (u.lvl * 2.5); u.xp += 12;
                if(u.xp >= u.lvl * 1000) { u.lvl++; u.xp = 0; notify("LVL UP!"); }
            }
            return u;
        });
    }

    function updateMarket() {
        const cont = document.getElementById('gpuContainer'); cont.innerHTML = '';
        GPUS.forEach(g => {
            const owned = (userData.gpus && userData.gpus[g.id]) || 0;
            cont.innerHTML += `<div class="gpu-card">
                <div class="gpu-info"><b>${g.n}</b><span>–î–æ—Ö–æ–¥: +${g.i.toLocaleString()} ‚ÇΩ/—Å–µ–∫ | –£ –≤–∞—Å: ${owned}</span></div>
                <button class="main-btn btn-outline" style="padding:12px 25px;" onclick="buyGpu('${g.id}', ${g.p})">${(g.p/1000).toLocaleString()}k ‚ÇΩ</button>
            </div>`;
        });
    }

    function buyGpu(id, price) {
        if(userData.balance >= price) {
            db.ref('users/'+user).transaction(u => {
                if(u) { u.balance -= price; if(!u.gpus) u.gpus={}; u.gpus[id] = (u.gpus[id]||0)+1; }
                return u;
            });
            playSfx(1100); setTimeout(updateMarket, 300);
        } else notify("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤!");
    }

    function openCase(cost, min, max) {
        if(userData.balance < cost) return notify("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–µ–Ω–µ–≥!");
        db.ref('users/'+user+'/balance').transaction(b => b - cost);
        const res = document.getElementById('caseResult'); res.innerText = "ROLLING...";
        playSfx(400, 'square', 1.5, 0.04);
        setTimeout(() => {
            let win = Math.floor(Math.random() * (max - min + 1)) + min;
            db.ref('users/'+user).transaction(u => { u.balance += win; u.xp += 100; return u; });
            res.innerText = win.toLocaleString() + " ‚ÇΩ";
            res.style.color = win > cost ? 'var(--green)' : 'var(--pink)';
            playSfx(win > cost ? 1200 : 300);
        }, 2000);
    }

    // --- SOCIAL & SYSTEM ---
    function pushChat() {
        const t = document.getElementById('chatInput').value.trim();
        if(t && user) {
            db.ref('chat').push().set({ u: user, t: ": " + t });
            document.getElementById('chatInput').value = '';
        }
    }

    function initLeaderboard() {
        db.ref('users').orderByChild('balance').limitToLast(10).on('value', s => {
            const list = document.getElementById('leaderboard'); list.innerHTML = '';
            let users = []; s.forEach(u => users.push({n: u.key, b: u.val().balance}));
            users.reverse().forEach((u, i) => {
                const glow = i === 0 ? 'border-color:var(--gold); box-shadow:0 0 15px var(--gold);' : '';
                list.innerHTML += `<div class="message" style="display:flex; justify-content:space-between; ${glow}">
                    <span>#${i+1} <b>${u.n}</b></span><b>${Math.floor(u.b).toLocaleString()} ‚ÇΩ</b>
                </div>`;
            });
        });
    }

    function tab(btn, id) {
        document.querySelectorAll('.nav-btn, .viewport').forEach(x => x.classList.remove('active'));
        btn.classList.add('active'); document.getElementById(id).classList.add('active');
        if(id === 'vMining') updateMarket();
    }
</script>
</body>
</html>
