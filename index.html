<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TORNADO V9.5 | TITAN STABLE</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --accent: #00f2ff; --pink: #ff007b; --gold: #ffcc00; --green: #00ff88;
            --bg: #030507; --card: rgba(10, 15, 20, 0.98); --border: rgba(0, 242, 255, 0.2);
        }

        * { box-sizing: border-box; transition: 0.2s; outline: none; }
        body {
            font-family: 'Inter', sans-serif; background: var(--bg); color: #fff;
            margin: 0; height: 100vh; display: flex; justify-content: center; align-items: center;
            overflow: hidden;
        }

        .app-container { display: grid; grid-template-columns: 1fr 400px; gap: 20px; width: 99vw; height: 98vh; max-width: 1800px; padding: 10px; }
        .glass-panel { background: var(--card); border: 1px solid var(--border); border-radius: 30px; display: flex; flex-direction: column; overflow: hidden; backdrop-filter: blur(25px); box-shadow: 0 20px 60px rgba(0,0,0,0.8); }

        /* Auth System */
        #authBox { width: 480px; padding: 60px; text-align: center; position: absolute; z-index: 99999; border: 1px solid var(--accent); }
        .auth-nav { display: flex; gap: 10px; margin-bottom: 30px; background: rgba(0,0,0,0.5); padding: 5px; border-radius: 15px; }
        .auth-tab { flex: 1; padding: 12px; border-radius: 12px; cursor: pointer; font-size: 11px; font-weight: 900; color: #5d727b; text-transform: uppercase; }
        .auth-tab.active { background: var(--accent); color: #000; }

        /* Top Navigation */
        .sidebar-nav { display: flex; background: rgba(0,0,0,0.5); padding: 15px; gap: 8px; border-bottom: 1px solid var(--border); overflow-x: auto; scrollbar-width: none; }
        .nav-btn { padding: 12px 22px; border-radius: 15px; cursor: pointer; font-size: 10px; font-weight: 800; text-transform: uppercase; color: #5d727b; white-space: nowrap; border: 1px solid transparent; }
        .nav-btn.active { background: rgba(0, 242, 255, 0.1); color: var(--accent); border-color: var(--border); }

        .viewport { flex: 1; overflow-y: auto; padding: 30px; display: none; flex-direction: column; gap: 20px; }
        .viewport.active { display: flex; animation: viewIn 0.3s ease-out; }
        @keyframes viewIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Games Layout */
        .crash-area { height: 380px; background: #050709; border-radius: 25px; position: relative; overflow: hidden; border: 1px solid var(--border); }
        #crashCanvas { width: 100%; height: 100%; }
        .crash-info { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; pointer-events: none; z-index: 10; }
        #crashMult { font-family: 'Orbitron'; font-size: 5.5rem; font-weight: 900; text-shadow: 0 0 40px var(--accent); margin: 0; }
        
        .mines-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; width: 100%; max-width: 600px; margin: 0 auto; padding: 20px; }
        .game-cell { aspect-ratio: 1; background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 32px; transition: 0.15s; }
        .game-cell:hover { background: rgba(0, 242, 255, 0.1); transform: scale(1.05); }
        .game-cell.active { background: var(--accent); box-shadow: 0 0 30px var(--accent); color: #000; border: none; }
        .game-cell.death { background: var(--pink); box-shadow: 0 0 30px var(--pink); color: #fff; }

        /* UI Elements */
        .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .field { background: rgba(0,0,0,0.6); border: 1px solid var(--border); padding: 18px; border-radius: 20px; color: #fff; font-family: 'Orbitron'; font-size: 16px; width: 100%; }
        .btn-ui { border: none; padding: 20px; border-radius: 20px; font-weight: 900; cursor: pointer; text-transform: uppercase; font-family: 'Orbitron'; font-size: 13px; letter-spacing: 1px; }
        .btn-accent { background: linear-gradient(135deg, var(--accent), #0072ff); color: #000; }
        .btn-green { background: linear-gradient(135deg, var(--green), #00b35d); color: #000; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: #fff; }

        /* Sidebar Stats */
        .user-block { padding: 30px; text-align: center; border-bottom: 1px solid var(--border); background: linear-gradient(180deg, rgba(0,242,255,0.05) 0%, transparent 100%); }
        .bal-display { font-family: 'Orbitron'; font-size: 2.5rem; font-weight: 900; color: var(--accent); }
        .xp-line { height: 10px; background: rgba(255,255,255,0.05); border-radius: 10px; overflow: hidden; margin: 15px 0; }
        .xp-bar { height: 100%; width: 0%; background: var(--accent); box-shadow: 0 0 10px var(--accent); transition: 0.5s; }

        /* CHAT FIX */
        .chat-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: rgba(0,0,0,0.2); }
        #chatBox { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; scroll-behavior: smooth; }
        .msg { background: rgba(255,255,255,0.03); padding: 12px 16px; border-radius: 18px; font-size: 13px; line-height: 1.4; border-left: 3px solid var(--accent); align-self: flex-start; max-width: 90%; }
        .msg b { color: var(--accent); font-family: 'Orbitron'; font-size: 10px; display: block; margin-bottom: 3px; }

        /* Mining Farm */
        .gpu-item { background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 22px; padding: 20px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .gpu-name { font-weight: 800; color: var(--accent); font-size: 16px; }

        /* Notifications */
        #notif { position: fixed; top: 20px; right: 20px; z-index: 999999; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: #111; border: 1px solid var(--accent); padding: 15px 25px; border-radius: 15px; animation: slideIn 0.3s forwards; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        @keyframes slideIn { from { transform: translateX(120%); } to { transform: translateX(0); } }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }
    </style>
</head>
<body>

<div id="notif"></div>

<div id="authBox" class="glass-panel">
    <h1 style="font-family:'Orbitron'; font-size: 2.5rem; margin:0; color:var(--accent);">TORNADO</h1>
    <p style="letter-spacing: 8px; font-size: 10px; color: #5d727b; margin-bottom: 30px;">ULTRA STABLE V9.5</p>
    <div class="auth-nav">
        <div class="auth-tab active" id="tabLogin" onclick="setAuth('login')">–í—Ö–æ–¥</div>
        <div class="auth-tab" id="tabReg" onclick="setAuth('reg')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
    </div>
    <input type="text" id="authUser" placeholder="–õ–û–ì–ò–ù" class="field" style="margin-bottom: 15px;">
    <input type="password" id="authPass" placeholder="–ü–ê–†–û–õ–¨" class="field" style="margin-bottom: 25px;">
    <button class="btn-ui btn-accent" style="width:100%" onclick="handleAuth()">–ü–û–î–¢–í–ï–†–î–ò–¢–¨</button>
</div>

<div class="app-container" id="mainApp" style="display: none;">
    <div class="glass-panel">
        <div class="sidebar-nav">
            <div class="nav-btn active" onclick="showTab(this, 'viewCrash')">CRASH</div>
            <div class="nav-btn" onclick="showTab(this, 'viewMines')">MINES</div>
            <div class="nav-btn" onclick="showTab(this, 'viewLadder')">LADDER</div>
            <div class="nav-btn" onclick="showTab(this, 'viewMining')">MINING</div>
            <div class="nav-btn" onclick="showTab(this, 'viewCases')">CASES</div>
            <div class="nav-btn" onclick="showTab(this, 'viewTop')">LEADERS</div>
        </div>

        <div id="viewCrash" class="viewport active">
            <div class="crash-area">
                <canvas id="crashCanvas"></canvas>
                <div class="crash-info">
                    <div id="crashMult">1.00x</div>
                    <div id="crashProfit" style="color:var(--green); font-family:'Orbitron'; font-size:1.5rem; height:30px;"></div>
                </div>
            </div>
            <div class="input-row">
                <input type="number" id="betCrash" placeholder="–°–¢–ê–í–ö–ê" class="field">
                <input type="number" id="autoCrash" placeholder="–ê–í–¢–û (1.5)" class="field">
            </div>
            <button id="btnCrash" class="btn-ui btn-accent" onclick="actionCrash()">–ü–û–°–¢–ê–í–ò–¢–¨</button>
        </div>

        <div id="viewMines" class="viewport">
            <div class="input-row">
                <input type="number" id="betMines" placeholder="–°–¢–ê–í–ö–ê" class="field">
                <select id="cntMines" class="field" style="background:#000;">
                    <option value="3">3 –ú–ò–ù–´</option>
                    <option value="10">10 –ú–ò–ù</option>
                    <option value="24">24 –ú–ò–ù–´</option>
                </select>
            </div>
            <div id="gridMines" class="mines-grid"></div>
            <button id="btnMines" class="btn-ui btn-accent" onclick="startMines()">–ò–ì–†–ê–¢–¨</button>
        </div>

        <div id="viewLadder" class="viewport">
            <div class="input-row" style="grid-template-columns: 1fr 1fr 1fr;">
                <input type="number" id="betLadder" placeholder="–°–¢–ê–í–ö–ê" class="field">
                <select id="stepLadder" class="field" style="background:#000;">
                    <option value="5">5 –®–ê–ì–û–í</option>
                    <option value="8" selected>8 –®–ê–ì–û–í</option>
                    <option value="12">12 –®–ê–ì–û–í</option>
                </select>
                <button id="startLadder" class="btn-ui btn-accent" onclick="initLadder()">–°–¢–ê–†–¢</button>
            </div>
            <div id="areaLadder" style="display:flex; flex-direction:column-reverse; gap:10px; align-items:center;"></div>
        </div>

        <div id="viewMining" class="viewport">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                <button class="btn-ui btn-accent" style="height:150px;" onclick="clickFarm()">
                    <span style="font-size:25px;">–ö–õ–ò–ö–ê–¢–¨</span><br><span id="valClick" style="font-size:10px;">+2.50 ‚ÇΩ</span>
                </button>
                <div class="glass-panel" style="justify-content:center; align-items:center; background:rgba(0,0,0,0.3);">
                    <p style="font-size:10px; color:#5d727b; margin:0;">–î–û–•–û–î –í –°–ï–ö–£–ù–î–£</p>
                    <h2 id="valPassive" style="color:var(--green); margin:10px 0;">0 ‚ÇΩ</h2>
                </div>
            </div>
            <div id="listGPU" style="margin-top:20px;"></div>
        </div>

        <div id="viewCases" class="viewport">
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap:20px;">
                <div class="glass-panel" style="padding:25px; text-align:center;">
                    <h3>–ë–†–û–î–Ø–ì–ê</h3>
                    <p style="color:var(--gold); font-size:12px;">–í—ã–∏–≥—Ä—ã—à: 200 - 5,000 ‚ÇΩ</p>
                    <button class="btn-ui btn-outline" style="width:100%; margin-top:15px;" onclick="openBox(1000, 200, 5000)">1,000 ‚ÇΩ</button>
                </div>
                <div class="glass-panel" style="padding:25px; text-align:center; border-color:var(--accent);">
                    <h3>–ú–ê–ì–ù–ê–¢</h3>
                    <p style="color:var(--gold); font-size:12px;">–í—ã–∏–≥—Ä—ã—à: 10,000 - 150,000 ‚ÇΩ</p>
                    <button class="btn-ui btn-accent" style="width:100%; margin-top:15px;" onclick="openBox(30000, 10000, 150000)">30,000 ‚ÇΩ</button>
                </div>
                <div class="glass-panel" style="padding:25px; text-align:center; border-color:var(--pink);">
                    <h3>ELITE</h3>
                    <p style="color:var(--gold); font-size:12px;">–í—ã–∏–≥—Ä—ã—à: 50,000 - 1,000,000 ‚ÇΩ</p>
                    <button class="btn-ui btn-accent" style="width:100%; margin-top:15px; background:var(--pink); color:#fff;" onclick="openBox(200000, 50000, 1000000)">200,000 ‚ÇΩ</button>
                </div>
            </div>
            <h1 id="boxRes" style="text-align:center; font-family:'Orbitron'; margin-top:50px; font-size:3rem;"></h1>
        </div>

        <div id="viewTop" class="viewport">
            <h1 style="font-family:'Orbitron'; text-align:center;">LEADERBOARD</h1>
            <div id="listTop" style="display:flex; flex-direction:column; gap:10px;"></div>
        </div>
    </div>

    <div class="glass-panel">
        <div class="user-block">
            <div class="bal-display" id="uBalance">0 ‚ÇΩ</div>
            <div class="xp-line"><div class="xp-bar" id="uBar"></div></div>
            <div style="display:flex; justify-content:space-between; font-size:10px; font-weight:900; color:#5d727b;">
                <span id="uLevel">LVL 1</span><span id="uXP">0 / 1000</span>
            </div>
        </div>
        <div class="chat-container">
            <div id="chatBox"></div>
            <div style="padding:20px; display:flex; gap:10px;">
                <input type="text" id="chatInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." class="field" style="padding:12px;">
                <button class="btn-ui btn-accent" style="padding:0 20px;" onclick="sendMsg()">></button>
            </div>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
    // --- DATABASE CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyC8UkaoaI7nHRSxNPddRwXnNxzHX7kt8s8",
        authDomain: "tornadogame-41ae2.firebaseapp.com",
        databaseURL: "https://tornadogame-41ae2-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "tornadogame-41ae2",
        appId: "1:926174944730:web:20be5b57efb23ab853b4e3"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- GAME ENGINE STATE ---
    let user = null, userData = {}, authMode = 'login', audio;
    let crash = { active: false, mult: 1.0, bet: 0, cashed: false, pts: [] };
    let mines = { active: false, bet: 0, bombs: [], open: 0, total: 3 };
    let ladder = { active: false, bet: 0, step: 0, max: 8 };

    const GPUS = [
        {id:'g1', n:'GTX 1050', p:15000, i:15},
        {id:'g2', n:'RTX 2060', p:80000, i:110},
        {id:'g3', n:'RTX 3080', p:450000, i:600},
        {id:'g4', n:'RTX 4090', p:1500000, i:2500},
        {id:'g5', n:'TESLA V100', p:8000000, i:15000},
        {id:'g6', n:'TITAN RTX', p:25000000, i:60000}
    ];

    function sfx(f, t='sine', d=0.15, v=0.07) {
        if(!audio) audio = new (window.AudioContext || window.webkitAudioContext)();
        const o = audio.createOscillator(); const g = audio.createGain();
        o.type = t; o.frequency.setValueAtTime(f, audio.currentTime);
        g.gain.setValueAtTime(v, audio.currentTime);
        g.gain.exponentialRampToValueAtTime(0.0001, audio.currentTime + d);
        o.connect(g); g.connect(audio.destination); o.start(); o.stop(audio.currentTime + d);
    }

    function toast(t) {
        const b = document.getElementById('notif');
        const e = document.createElement('div'); e.className = 'toast'; e.innerText = t;
        b.appendChild(e); setTimeout(() => e.remove(), 3500);
    }

    // --- AUTH ---
    function setAuth(m) {
        authMode = m;
        document.getElementById('tabLogin').classList.toggle('active', m==='login');
        document.getElementById('tabReg').classList.toggle('active', m==='reg');
    }

    function handleAuth() {
        const u = document.getElementById('authUser').value.trim().toLowerCase();
        const p = document.getElementById('authPass').value.trim();
        if(u.length < 3) return toast("–õ–æ–≥–∏–Ω —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π");

        db.ref('users/' + u).once('value', s => {
            if(authMode === 'login') {
                if(s.exists() && s.val().pass === p) run(u, s.val());
                else toast("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞!");
            } else {
                if(s.exists()) toast("–õ–æ–≥–∏–Ω –∑–∞–Ω—è—Ç!");
                else {
                    const d = { pass: p, balance: 10000, xp: 0, lvl: 1, gpus: {} };
                    db.ref('users/' + u).set(d).then(() => run(u, d));
                }
            }
        });
    }

    function run(id, data) {
        user = id;
        document.getElementById('authBox').style.display = 'none';
        document.getElementById('mainApp').style.display = 'grid';
        
        db.ref('users/' + user).on('value', s => {
            userData = s.val();
            updateUI();
        });

        // CHAT SYNC
        db.ref('chat').limitToLast(30).on('value', s => {
            const b = document.getElementById('chatBox');
            b.innerHTML = '';
            s.forEach(m => {
                b.innerHTML += `<div class="msg"><b>${m.val().u}</b>${m.val().t}</div>`;
            });
            b.scrollTop = b.scrollHeight; // –§–∏–∫—Å —Å–∫—Ä–æ–ª–ª–∞
        });

        initCrash();
        syncGPU();
        syncTop();

        setInterval(() => {
            let inc = 0; if(userData.gpus) GPUS.forEach(g => inc += (userData.gpus[g.id]||0)*g.i);
            if(inc > 0) db.ref('users/'+user+'/balance').transaction(b => (b||0) + inc);
        }, 1000);
    }

    function updateUI() {
        document.getElementById('uBalance').innerText = Math.floor(userData.balance).toLocaleString() + ' ‚ÇΩ';
        const nx = userData.lvl * 1000;
        document.getElementById('uBar').style.width = (userData.xp / nx * 100) + '%';
        document.getElementById('uLevel').innerText = 'LVL ' + userData.lvl;
        document.getElementById('uXP').innerText = `${userData.xp} / ${nx}`;
        document.getElementById('valClick').innerText = `+${(userData.lvl * 2.5).toFixed(2)} ‚ÇΩ`;
        
        let pass = 0; if(userData.gpus) GPUS.forEach(g => pass += (userData.gpus[g.id]||0)*g.i);
        document.getElementById('valPassive').innerText = pass.toLocaleString() + ' ‚ÇΩ/—Å–µ–∫';
    }

    // --- CRASH ---
    const cvs = document.getElementById('crashCanvas');
    const ctx = cvs.getContext('2d');
    function initCrash() {
        crash.active = false; crash.mult = 1.0; crash.cashed = false; crash.pts = [];
        const btn = document.getElementById('btnCrash');
        btn.innerText = "–°–¢–ê–í–ö–ê"; btn.className = 'btn-ui btn-accent'; btn.disabled = false;
        document.getElementById('crashProfit').innerText = '';
        
        let t = 10;
        let itv = setInterval(() => {
            t--; document.getElementById('crashMult').innerText = t + 's';
            if(t <= 0) { clearInterval(itv); startCrash(); }
        }, 1000);
    }

    function startCrash() {
        crash.active = true;
        cvs.width = cvs.offsetWidth; cvs.height = cvs.offsetHeight;
        let boom = Math.random() < 0.1 ? 1.0 : (Math.random() * 5 + 1.1);
        let start = Date.now();
        
        if(crash.bet > 0) {
            document.getElementById('btnCrash').innerText = "–í–´–í–û–î";
            document.getElementById('btnCrash').className = 'btn-ui btn-green';
        }

        let loop = setInterval(() => {
            let now = (Date.now() - start) / 1000;
            crash.mult = Math.pow(1.07, now).toFixed(2);
            
            ctx.clearRect(0,0,cvs.width, cvs.height);
            ctx.strokeStyle = '#00f2ff'; ctx.lineWidth = 5;
            let x = (now / 10) * cvs.width;
            let y = cvs.height - ((crash.mult - 1) / 4) * cvs.height;
            crash.pts.push({x, y});
            ctx.beginPath(); ctx.moveTo(0, cvs.height);
            crash.pts.forEach(p => ctx.lineTo(p.x, p.y)); ctx.stroke();

            if(crash.mult >= boom) {
                clearInterval(loop); crash.active = false;
                document.getElementById('crashMult').innerText = 'BOOM!';
                sfx(100, 'sawtooth'); crash.bet = 0; setTimeout(initCrash, 3000);
            } else {
                document.getElementById('crashMult').innerText = crash.mult + 'x';
                if(crash.bet > 0 && !crash.cashed) {
                    document.getElementById('crashProfit').innerText = '+' + Math.floor(crash.bet * crash.mult) + ' ‚ÇΩ';
                    if(parseFloat(document.getElementById('autoCrash').value) <= crash.mult) actionCrash();
                }
            }
        }, 50);
    }

    function actionCrash() {
        if(!crash.active) {
            let b = parseInt(document.getElementById('betCrash').value);
            if(b > 0 && b <= userData.balance) {
                crash.bet = b; db.ref('users/'+user+'/balance').transaction(v => v - b);
                document.getElementById('btnCrash').innerText = "–ñ–î–ï–ú..."; document.getElementById('btnCrash').disabled = true;
            }
        } else if(crash.bet > 0 && !crash.cashed) {
            crash.cashed = true;
            let win = Math.floor(crash.bet * crash.mult);
            db.ref('users/'+user).transaction(u => { u.balance += win; u.xp += 25; return u; });
            document.getElementById('btnCrash').innerText = "–í–ó–Ø–¢–û"; document.getElementById('btnCrash').disabled = true;
            sfx(800);
        }
    }

    // --- MINES ---
    function startMines() {
        let b = parseInt(document.getElementById('betMines').value);
        if(b > 0 && b <= userData.balance) {
            db.ref('users/'+user+'/balance').transaction(v => v - b);
            mines.active = true; mines.bet = b; mines.open = 0;
            mines.total = parseInt(document.getElementById('cntMines').value);
            mines.bombs = []; while(mines.bombs.length < mines.total) {
                let r = Math.floor(Math.random()*25); if(!mines.bombs.includes(r)) mines.bombs.push(r);
            }
            const g = document.getElementById('gridMines'); g.innerHTML = '';
            for(let i=0; i<25; i++) {
                const c = document.createElement('div'); c.className = 'game-cell';
                c.onclick = () => {
                    if(!mines.active || c.classList.contains('active')) return;
                    if(mines.bombs.includes(i)) {
                        mines.active = false; c.classList.add('death'); c.innerText = 'üí£';
                        sfx(120, 'sawtooth'); setTimeout(() => { toast("–í–ó–†–´–í!"); g.innerHTML = ''; resetMines(); }, 600);
                    } else {
                        c.classList.add('active'); c.innerText = 'üíé'; mines.open++;
                        sfx(500 + (mines.open*50));
                        let m = (1 + (mines.open * (mines.total/4))).toFixed(2);
                        document.getElementById('btnMines').innerText = `–ó–ê–ë–†–ê–¢–¨ (${m}x)`;
                    }
                };
                g.appendChild(c);
            }
            document.getElementById('btnMines').innerText = "–ó–ê–ë–†–ê–¢–¨ (1.00x)";
            document.getElementById('btnMines').onclick = () => {
                if(!mines.active || mines.open === 0) return;
                let w = Math.floor(mines.bet * (1 + (mines.open * (mines.total/4))));
                db.ref('users/'+user).transaction(u => { u.balance += w; u.xp += 20; return u; });
                g.innerHTML = ''; resetMines(); sfx(1000);
            };
        }
    }
    function resetMines() {
        mines.active = false; document.getElementById('btnMines').innerText = "–ò–ì–†–ê–¢–¨";
        document.getElementById('btnMines').onclick = startMines;
    }

    // --- LADDER ---
    function initLadder() {
        let b = parseInt(document.getElementById('betLadder').value);
        if(b > 0 && b <= userData.balance) {
            db.ref('users/'+user+'/balance').transaction(v => v - b);
            ladder.active = true; ladder.bet = b; ladder.step = 0;
            ladder.max = parseInt(document.getElementById('stepLadder').value);
            const a = document.getElementById('areaLadder'); a.innerHTML = '';
            for(let i=0; i<ladder.max; i++) {
                const r = document.createElement('div'); r.style = "display:flex; gap:10px;";
                for(let j=0; j<2; j++) {
                    const s = document.createElement('div'); s.className = 'game-cell';
                    s.style = "width:100px; height:50px;";
                    if(i === 0) s.onclick = () => stepLad(j, s, i);
                    else s.style.opacity = "0.2";
                    r.appendChild(s);
                }
                a.appendChild(r);
            }
            document.getElementById('startLadder').innerText = "CASH (1.00x)";
            document.getElementById('startLadder').onclick = cashLad;
        }
    }

    function stepLad(c, el, idx) {
        if(!ladder.active || idx !== ladder.step) return;
        if(Math.random() < 0.5) {
            ladder.active = false; el.classList.add('death'); sfx(130, 'sawtooth');
            setTimeout(() => { toast("–£–ü–ê–õ!"); initLadder(); resetLad(); }, 500);
        } else {
            el.classList.add('active'); ladder.step++;
            sfx(600 + (ladder.step*60));
            let m = Math.pow(1.9, ladder.step).toFixed(2);
            document.getElementById('startLadder').innerText = `CASH (${m}x)`;
            const rows = document.getElementById('areaLadder').children;
            if(ladder.step < ladder.max) {
                Array.from(rows[ladder.step].children).forEach(s => { s.style.opacity = "1"; s.onclick = () => stepLad(0, s, ladder.step); });
            }
        }
    }

    function cashLad() {
        if(!ladder.active) return;
        let w = Math.floor(ladder.bet * Math.pow(1.9, ladder.step));
        db.ref('users/'+user).transaction(u => { u.balance += w; u.xp += 40; return u; });
        resetLad(); sfx(1200);
    }
    function resetLad() {
        ladder.active = false; document.getElementById('startLadder').innerText = "–°–¢–ê–†–¢";
        document.getElementById('startLadder').onclick = initLadder;
    }

    // --- OTHER ---
    function clickFarm() {
        sfx(400);
        db.ref('users/'+user).transaction(u => {
            if(u) { u.balance += (u.lvl*2.5); u.xp += 10; if(u.xp >= u.lvl*1000) { u.lvl++; u.xp = 0; toast("LEVEL UP!"); } }
            return u;
        });
    }

    function syncGPU() {
        const c = document.getElementById('listGPU'); c.innerHTML = '';
        GPUS.forEach(g => {
            let h = (userData.gpus && userData.gpus[g.id]) || 0;
            c.innerHTML += `<div class="gpu-item">
                <div><div class="gpu-name">${g.n}</div><small>+${g.i}‚ÇΩ/—Å | –£ –≤–∞—Å: ${h}</small></div>
                <button class="btn-ui btn-outline" style="padding:10px 20px" onclick="buyGPU('${g.id}', ${g.p})">${g.p/1000}k ‚ÇΩ</button>
            </div>`;
        });
    }

    function buyGPU(id, p) {
        if(userData.balance >= p) {
            db.ref('users/'+user).transaction(u => {
                if(u) { u.balance -= p; if(!u.gpus) u.gpus={}; u.gpus[id] = (u.gpus[id]||0)+1; }
                return u;
            });
            setTimeout(syncGPU, 200);
        } else toast("–ú–∞–ª–æ –¥–µ–Ω–µ–≥!");
    }

    function openBox(cost, min, max) {
        if(userData.balance < cost) return toast("–ú–∞–ª–æ –¥–µ–Ω–µ–≥!");
        db.ref('users/'+user+'/balance').transaction(b => b - cost);
        const r = document.getElementById('boxRes'); r.innerText = "ROLLING...";
        setTimeout(() => {
            let w = Math.floor(Math.random() * (max - min)) + min;
            db.ref('users/'+user).transaction(u => { u.balance += w; u.xp += 50; return u; });
            r.innerText = w.toLocaleString() + " ‚ÇΩ";
            sfx(w > cost ? 1000 : 300);
        }, 1500);
    }

    function sendMsg() {
        let t = document.getElementById('chatInput').value.trim();
        if(t && user) {
            db.ref('chat').push().set({ u: user, t: ": " + t });
            document.getElementById('chatInput').value = '';
        }
    }

    function syncTop() {
        db.ref('users').once('value', s => {
            const list = document.getElementById('listTop');
            list.innerHTML = '';
            let users = [];
            s.forEach(u => { users.push({name: u.key, bal: u.val().balance}); });
            users.sort((a,b) => b.bal - a.bal);
            users.slice(0, 10).forEach((u, i) => {
                list.innerHTML += `<div class="msg" style="display:flex; justify-content:space-between; width:100%; border-color:${i==0?'var(--gold)':'var(--accent)'}">
                    <span>#${i+1} ${u.name}</span><b>${Math.floor(u.bal).toLocaleString()} ‚ÇΩ</b>
                </div>`;
            });
        });
        setTimeout(syncTop, 10000); // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞–∑ –≤ 10 —Å–µ–∫
    }

    function showTab(btn, id) {
        document.querySelectorAll('.nav-btn, .viewport').forEach(x => x.classList.remove('active'));
        btn.classList.add('active'); document.getElementById(id).classList.add('active');
        if(id === 'viewMining') syncGPU();
    }
</script>
</body>
</html>
